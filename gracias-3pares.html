<!DOCTYPE html>
<html>
<head>
<!-- Facebook Pixel Code -->
<script>
!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '1052677351596434');
fbq('track', 'PageView');
</script>
<noscript><img height="1" width="1" style="display:none"
src="https://www.facebook.com/tr?id=1052677351596434&ev=PageView&noscript=1"
/></noscript>
<!-- End Facebook Pixel Code -->
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>&iquest;C&oacute;mo comprar?</title>
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<link href="https://stefano.brilli.me/google-forms-html-exporter/styles/vendor.css" rel="stylesheet" />
	<link href="https://stefano.brilli.me/google-forms-html-exporter/styles/main.css" rel="stylesheet" />
	<style type="text/css">img {max-width:100%;}
      form {max-width:400px;     padding: 0px 5px;}
      button, html input[type=button], input[type=reset], input[type=submit] {margin-bottom: 10px; font-size: 20px; width: 100%;}
    .checkbox label, .radio label {padding-left:0px;}
    .checkbox-inline input[type=checkbox], .checkbox input[type=checkbox], .radio-inline input[type=radio], .radio input[type=radio] { margin-left: 0px; width: 30px; height: 30px; margin: 5px 280px;}
      input[type="checkbox"]:checked { box-shadow: 0 0 0 5px yellow;}
      input[type="checkbox"]:checked+img { box-shadow: 0 0 0 5px yellow;}
     ::placeholder { /* Chrome, Firefox, Opera, Safari 10.1+ */
  color: #777;
  opacity: 1; /* Firefox */
}

:-ms-input-placeholder { /* Internet Explorer 10-11 */
  color: #777;
}

::-ms-input-placeholder { /* Microsoft Edge */
  color: #777;
}

.myButton {
    -moz-box-shadow: inset 0px 1px 0px 0px #54a3f7;
    -webkit-box-shadow: inset 0px 1px 0px 0px #54a3f7;
    box-shadow: inset 0px 1px 0px 0px #54a3f7;
    background: -webkit-gradient(linear, left top, left bottom, color-stop(0.05, #007dc1), color-stop(1, #0061a7));
    background: -moz-linear-gradient(top, #007dc1 5%, #0061a7 100%);
    background: -webkit-linear-gradient(top, #007dc1 5%, #0061a7 100%);
    background: -o-linear-gradient(top, #007dc1 5%, #0061a7 100%);
    background: -ms-linear-gradient(top, #007dc1 5%, #0061a7 100%);
    background: linear-gradient(to bottom, #007dc1 5%, #0061a7 100%);
    filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#007dc1', endColorstr='#0061a7',GradientType=0);
    background-color: #3483fa;
    -moz-border-radius: 3px;
    -webkit-border-radius: 3px;
    border-radius: 3px;
    border: #3483fa;
    display: inline-block;
    cursor: pointer;
    color: #ffffff;
    font-family: Arial;
    text-align: center;
    font-size: 20px;
    width: 100%;
    padding: 5px 24px;
    text-decoration: none;
    text-shadow: 0px 1px 0px #3483fa;
}
.myButton:hover {
	background:-webkit-gradient(linear, left top, left bottom, color-stop(0.05, #0061a7), color-stop(1, #007dc1));
	background:-moz-linear-gradient(top, #0061a7 5%, #007dc1 100%);
	background:-webkit-linear-gradient(top, #0061a7 5%, #007dc1 100%);
	background:-o-linear-gradient(top, #0061a7 5%, #007dc1 100%);
	background:-ms-linear-gradient(top, #0061a7 5%, #007dc1 100%);
	background:linear-gradient(to bottom, #0061a7 5%, #007dc1 100%);
	filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#0061a7', endColorstr='#007dc1',GradientType=0);
	background-color:#0061a7;
}
.myButton:active {
	position:relative;
	top:1px;
}
	</style>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.form/4.2.2/jquery.form.min.js" integrity="sha256-2Pjr1OlpZMY6qesJM68t2v39t+lMLvxwpa8QlRjJroA=" crossorigin="anonymous"></script>
</head>
<body style="cursor: auto;">
<!-- GTM noscript removido - Facebook Pixel ya incluido arriba -->
<div style="max-width: 400px; padding: 0px 5px;">
<p><img alt="" src="rosita-form.png" /></p>


<h4 style="text-align: center;"><strong><span style="font-size:22px;"><span style="background-color:#FFFF00;">CONFIRMA TU PEDIDO AHORA</span></span></strong></h4>

<p style="text-align: center; margin: 15px 0;">Tu compra aún no finalizó. Toca el botón debajo para enviarnos WhatsApp y confirmar la entrega de tu pedido contrareembolso.</p>

<div style="text-align: center; margin: 20px 0;">
    <a id="wsplink" href="https://api.whatsapp.com/send?phone=5491127595502&text=Hola%20quiero%20confirmar%20mi%20pedido%20contrareembolso%20que%20reci%C3%A9n%20hice%3A%20">
        <img src="enviarwsp.png" alt="Enviar WhatsApp" style="max-width: 240px;">
    </a>
</div>

<script>
// Actualizar el enlace de WhatsApp con los detalles del pedido
document.addEventListener('DOMContentLoaded', function() {
    var wspLink = document.getElementById('wsplink');
    if (wspLink) {
        var detallesPedido = '';

        // Intentar obtener detalles de localStorage primero
        var talleselegidos = localStorage.getItem('orderDetails') || sessionStorage.getItem('orderDetails') || '';
        if (talleselegidos) {
            detallesPedido = talleselegidos;
        } else {
            // Si no hay detalles en localStorage, intentar obtenerlos de los parámetros URL
            var urlParams = getUrlParameter('286442883') || getUrlParameter('entry.1471599855') || '';
            if (urlParams) {
                detallesPedido = procesarProductos(urlParams);
            }
        }

        // Obtener el nombre del cliente si está disponible
        var nombreCliente = localStorage.getItem('customerName') || sessionStorage.getItem('customerName') || '';

        // Construir el mensaje de WhatsApp
        var mensajeWhatsApp = 'Hola, quiero confirmar mi pedido contrareembolso que recién hice';

        // Agregar el nombre si está disponible
        if (nombreCliente) {
            mensajeWhatsApp = 'Hola, soy ' + nombreCliente + ' y quiero confirmar mi pedido contrareembolso que recién hice';
        }

        // Agregar los detalles del pedido si están disponibles
        if (detallesPedido) {
            mensajeWhatsApp += '.\n\nDetalles del pedido: ' + detallesPedido;
        }

        var baseUrl = wspLink.href.split('?')[0];
        var newUrl = baseUrl + '?phone=5491127595502&text=' + encodeURIComponent(mensajeWhatsApp);
        wspLink.href = newUrl;

        console.log('URL de WhatsApp actualizada:', newUrl);
        console.log('Mensaje de WhatsApp:', mensajeWhatsApp);
    }
});
</script>

<div style="padding:10px; background-color: lightyellow; margin: auto;border:1px solid lightgrey;"><span id="talleselegidos"></span></div>

<p></p>
<p><span style="color:#00a650"><b>ENVÍO GRATIS</b> y <b>AHORA 3 y 6</b> Cuotas SIN INTERÉS.</span></p>
<p><span style="color:#000000;"><span style="font-size:14px;"><u><strong>Tarjeta de crédito/débito:</strong></u></span></span></p>

<p style="display:none;" id="mercadopago-3pares" style="font-size:20px;">
<script src="https://www.mercadopago.com.ar/integrations/v1/web-payment-checkout.js"
data-preference-id="270831598-75688e30-7979-4d9e-b26f-106163c90e88" data-source="button">
</script>
</p>

<p>Toc&aacute;&nbsp;el bot&oacute;n azul&nbsp;arriba para ir a pagar con cualquier tarjeta de cr&eacute;dito o d&eacute;bito en la plataforma segura de Mercadopago.&nbsp; Podr&aacute;s elegir 1 pago o en cuotas sin interés. Luego de pagar recibir&aacute;s un email desde Mercadopago confirmando tu pago.</p>

<p>&nbsp;</p>

<p><span style="color:#000000;"><span style="font-size:14px;"><u><strong>Transferencia Bancaria:</strong></u></span></span></p>

<p>Banco Santander<br>
Tipo y número de cuenta: Cuentas en Pesos  570-353877/1<br>
Número de CBU: 0720570588000035387718 <br>
Alias de CBU: ESCUDO.HIJA.PESCA<br>
Titular de la cuenta: Baustian Roxana Ines<br>
Tipo y número de documento: DNI - 29410535</p>

<p>Pag&aacute; y mandanos una foto del ticket de pago.</p>

<p>Pag&aacute; <strong>$15500</strong> por 3 pares. El env&iacute;o es GRATIS en todos los casos.</p>

<p>Luego de pagar mandanos&nbsp;foto del ticket de pago <a href="http://bit.ly/wspb-rosita">por Whatsapp tocando aqu&iacute; &gt;</a></p>

<p>Sin la foto del ticket de pago tu pedido NO se procesa.</p>

<p>&iexcl;Gracias! Aguardamos tu PAGO y tu AVISO por Whatsapp para despachar!!<br />
Whatsapp aqu&iacute; =&gt; <a href="http://bit.ly/wspb-rosita" style="background-color: rgb(252, 252, 252);">http://bit.ly/wspb-rosita</a></p>

</div>
<script>
// Función para obtener parámetros de URL
var getUrlParameter = function getUrlParameter(sParam) {
    var sPageURL = window.location.search.substring(1),
        sURLVariables = sPageURL.split('&'),
        sParameterName,
        i;

    for (i = 0; i < sURLVariables.length; i++) {
        sParameterName = sURLVariables[i].split('=');

        if (sParameterName[0] === sParam) {
            return sParameterName[1] === undefined ? true : decodeURIComponent(sParameterName[1]);
        }
    }
    return '';
};

// Función para procesar productos y generar detalles formateados
function procesarProductos(productos) {
    if (!productos) return '';

    var pairs = productos.split(', ').filter(Boolean);
    var values = [];

    for (var i = 0; i < pairs.length; i++) {
        var parts = pairs[i].split('-');
        if (parts.length < 2) continue;

        var talle = parts[0].trim();
        var modelo = parts[1];
        var color = parts.slice(2).join(' ');

        // Mapeo de códigos de modelo a nombres legibles
        var modeloNombre;
        var modeloId;

        switch(modelo) {
            case 'roma':
                modeloNombre = 'Botineta Roma';
                modeloId = '#4016';
                break;
            case 'venecia':
                modeloNombre = 'Venecia';
                modeloId = '#4015';
                break;
            case 'siena':
                modeloNombre = 'Borcego Siena';
                modeloId = '#SIENA';
                break;
            case 'paris':
                modeloNombre = 'Paris';
                modeloId = '#PARIS';
                break;
            default:
                modeloNombre = modelo.charAt(0).toUpperCase() + modelo.slice(1);
                modeloId = 'desconocido';
                break;
        }

        // Agregar el color al nombre del modelo si existe
        if (color) {
            modeloNombre += ' ' + color;
        }

        var modelosangies = 'Talle: ' + talle + ' Modelo: ' + modeloNombre;
        values.push(modelosangies);
    }

    return values.join(' || ');
}

// Get order details from localStorage (primary) or sessionStorage (fallback)
var talleselegidos = localStorage.getItem('orderDetails') || sessionStorage.getItem('orderDetails') || '';
console.log('Datos recuperados de localStorage:', {
    orderDetails: localStorage.getItem('orderDetails'),
    rawProducts: localStorage.getItem('rawProducts'),
    customerName: localStorage.getItem('customerName')
});

if (talleselegidos) {
    $("#talleselegidos").html(talleselegidos);
    console.log('Usando detalles de localStorage:', talleselegidos);
} else {
    // Fallback to URL parameters if storage is empty
    var urlParams = getUrlParameter('286442883') || getUrlParameter('entry.1471599855') || '';
    if (urlParams) {
        // Procesar los productos para mostrar detalles formateados
        var detallesFormateados = procesarProductos(urlParams);
        if (detallesFormateados) {
            $("#talleselegidos").html(detallesFormateados);
            console.log('Detalles procesados de URL:', detallesFormateados);

            // Guardar en localStorage para futuras referencias
            localStorage.setItem('orderDetails', detallesFormateados);
            localStorage.setItem('rawProducts', urlParams);
        } else {
            // Si no se pueden procesar, mostrar los parámetros crudos
            $("#talleselegidos").html(urlParams);
            console.log('Usando parámetros crudos de URL:', urlParams);
        }
    } else {
        $("#talleselegidos").html('Detalles del pedido no disponibles');
        console.log('No se encontraron detalles del pedido');
    }
}

// Display customer name if available
var customerName = localStorage.getItem('customerName') || sessionStorage.getItem('customerName');
if (customerName) {
    var greetingElement = document.createElement('p');
    greetingElement.innerHTML = '¡Gracias por tu compra, <strong>' + customerName + '</strong>!';
    greetingElement.style.textAlign = 'center';
    greetingElement.style.marginTop = '10px';

    var targetElement = document.querySelector('.form-group, #talleselegidos');
    if (targetElement && targetElement.parentNode) {
        targetElement.parentNode.insertBefore(greetingElement, targetElement.nextSibling);
    } else {
        // Si no se encuentra el elemento objetivo, agregar al principio del contenedor
        var container = document.querySelector('div[style*="max-width: 400px"]');
        if (container) {
            container.insertBefore(greetingElement, container.firstChild.nextSibling);
        }
    }
}

// Facebook Pixel Purchase Event - Previo Pago 3+ Pares
(function() {
    // Función para generar Event ID único
    function generateEventId() {
        return 'fb_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    // Función auxiliar para obtener cookies
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return '';
    }

    // Función para establecer cookies
    function setCookie(name, value, days) {
        const expires = new Date();
        expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
        document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/;SameSite=Lax`;
    }

    // Función para obtener parámetro de URL
    function getUrlParameter(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
    }

    // Función para generar y gestionar FBC (Facebook Click ID)
    function generateFBC() {
        let fbc = getCookie('_fbc');

        // Si no existe FBC, intentar crearlo desde fbclid guardado o URL
        if (!fbc) {
            // Primero intentar desde localStorage (fbclid guardado de visita inicial)
            const savedFbclid = localStorage.getItem('initial_fbclid');
            let fbclid = savedFbclid || getUrlParameter('fbclid');

            if (fbclid) {
                // Formato: fb.1.timestamp.fbclid
                fbc = `fb.1.${Math.floor(Date.now() / 1000)}.${fbclid}`;
                setCookie('_fbc', fbc, 90); // Guardar por 90 días
                console.log('✅ FBC generado desde fbclid:', fbc);
            }
        }

        return fbc || '';
    }

    // Función para generar y gestionar FBP (Facebook Browser ID)
    function generateFBP() {
        let fbp = getCookie('_fbp');

        // Si no existe FBP, generarlo
        if (!fbp) {
            // Formato: fb.1.timestamp.random
            const timestamp = Math.floor(Date.now() / 1000);
            const random = Math.random().toString(36).substr(2, 9);
            fbp = `fb.1.${timestamp}.${random}`;
            setCookie('_fbp', fbp, 90); // Guardar por 90 días
            console.log('✅ FBP generado:', fbp);
        }

        return fbp;
    }

    // Función para obtener FBC/FBP con generación automática
    function getFacebookParams() {
        return {
            fbc: generateFBC() || localStorage.getItem('facebook_fbc') || '',
            fbp: generateFBP() || localStorage.getItem('facebook_fbp') || ''
        };
    }

    // Función de envío dual para Purchase
    async function sendPurchaseEvent() {
        const eventId = generateEventId();

        // Datos del evento Purchase - Previo Pago 3+ Pares ($55.000 c/u)
        // Asumimos 3 pares como mínimo, pero podría ser más
        const eventData = {
            content_type: 'product',
            content_ids: ['3-pares-previo-pago'],
            contents: [{
                id: '3-pares-previo-pago',
                quantity: 3,
                item_price: 55000
            }],
            value: 165000, // 3 pares x $55.000
            currency: 'ARS',
            num_items: 3
        };

        // 1. Enviar a Facebook (Cliente)
        if (typeof fbq !== 'undefined') {
            fbq('track', 'Purchase', {
                ...eventData,
                event_id: eventId
            });
        }

        // 2. Obtener parámetros de Facebook (FBC/FBP) con generación automática
        const fbParams = getFacebookParams();

        // 3. Preparar payload para Facebook Events API (formato N8N)
        const facebookEventData = {
            event_name: 'Purchase',
            event_id: eventId,
            event_time: Math.floor(Date.now() / 1000),
            action_source: 'website',
            event_source_url: window.location.href,
            user_data: {
                client_ip_address: '', // N8N puede obtener esto del request
                client_user_agent: navigator.userAgent,
                fbc: fbParams.fbc,
                fbp: fbParams.fbp
            },
            custom_data: eventData
        };

        // 3. Enviar al webhook (Servidor)
        try {
            await fetch('https://sswebhookss.odontolab.co/webhook/9dfb840b-2a21-4277-8aec-1666bfaaac89', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    data: [facebookEventData] // Array con el evento, listo para Facebook Events API
                })
            });
            console.log('✅ Purchase enviado al servidor - FBC:', fbParams.fbc, 'FBP:', fbParams.fbp);
        } catch (error) {
            // Error silencioso
            console.error('Error enviando Purchase al servidor:', error);
        }
    }

    // Ejecutar cuando la página esté cargada
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', sendPurchaseEvent);
    } else {
        sendPurchaseEvent();
    }
})();
</script>
</body>
</html>
