---
// Carousel.astro - Componente de carrusel basado en Embla Carousel para Astro
interface Props {
  images: Array<{
    src: string;
    alt: string;
  }>;
  productId: string;
  autoplay?: boolean;
  delay?: number;
  showThumbnails?: boolean;
  className?: string;
}

const { 
  images, 
  productId, 
  autoplay = true, 
  delay = 3000,
  showThumbnails = true,
  className = ""
} = Astro.props;
---

<div class={`embla ${className}`} data-product-id={productId} data-autoplay={autoplay}>
  <!-- Carrusel Principal -->
  <div class="embla__viewport">
    <div class="embla__container">
      {images.map((image, index) => (
        <div class="embla__slide">
          <div class="embla__slide__inner">
            <img 
              class="embla__slide__img"
              src={image.src} 
              alt={image.alt}
              loading={index === 0 ? "eager" : "lazy"}
              decoding="async"
              fetchpriority={index === 0 ? "high" : "auto"}
            />
          </div>
        </div>
      ))}
    </div>
  </div>
  
  <!-- Botones de navegación -->
  <button class="embla__button embla__button--prev" type="button">
    <svg class="embla__button__svg" viewBox="0 0 24 24">
      <path d="M15 19l-7-7 7-7" fill="none" stroke="currentColor" stroke-width="2"/>
    </svg>
  </button>
  <button class="embla__button embla__button--next" type="button">
    <svg class="embla__button__svg" viewBox="0 0 24 24">
      <path d="M9 5l7 7-7 7" fill="none" stroke="currentColor" stroke-width="2"/>
    </svg>
  </button>

  <!-- Thumbnails -->
  {showThumbnails && images.length > 1 && (
    <div class="embla-thumbs">
      <div class="embla-thumbs__viewport">
        <div class="embla-thumbs__container">
          {images.map((image, index) => (
            <button class="embla-thumbs__slide" type="button">
              <img 
                class="embla-thumbs__slide__img"
                src={image.src} 
                alt={image.alt}
                loading="lazy"
              />
            </button>
          ))}
        </div>
      </div>
    </div>
  )}
</div>

<script>
  import emblaCarousel from 'embla-carousel';
  import Autoplay from 'embla-carousel-autoplay';
  
  // Inicializar carruseles cuando el DOM esté listo
  document.addEventListener('DOMContentLoaded', function() {
    initializeCarousels();
  });

  function initializeCarousels() {
    const emblaNodes = document.querySelectorAll('.embla');
    
    emblaNodes.forEach(emblaNode => {
      const viewportNode = emblaNode.querySelector('.embla__viewport');
      const thumbsNode = emblaNode.querySelector('.embla-thumbs__viewport');
      
      if (!viewportNode) return;
      
      // Opciones del carrusel principal
      const options = {
        align: 'start',
        loop: true,
        skipSnaps: false,
        containScroll: 'keepSnaps',
        dragFree: false,
      };
      
      // Plugin de autoplay
      const plugins = [];
      if (emblaNode.dataset.autoplay === 'true') {
        plugins.push(
          Autoplay({ 
            delay: 3000, 
            stopOnInteraction: true,
            playOnInit: true
          })
        );
      }
      
      // Inicializar carrusel principal
      const emblaApi = emblaCarousel(viewportNode, options, plugins);
      
      // Botones de navegación
      const prevBtn = emblaNode.querySelector('.embla__button--prev');
      const nextBtn = emblaNode.querySelector('.embla__button--next');
      
      if (prevBtn) {
        prevBtn.addEventListener('click', emblaApi.scrollPrev, false);
      }
      
      if (nextBtn) {
        nextBtn.addEventListener('click', emblaApi.scrollNext, false);
      }
      
      // Actualizar estado de los botones
      const setupPrevNextBtns = (disablePrev, disableNext) => {
        if (prevBtn) prevBtn.disabled = disablePrev;
        if (nextBtn) nextBtn.disabled = disableNext;
      };
      
      // Thumbnails
      let thumbsEmblaApi = null;
      if (thumbsNode) {
        const thumbsOptions = {
          containScroll: 'keepSnaps',
          dragFree: true,
        };
        thumbsEmblaApi = emblaCarousel(thumbsNode, thumbsOptions);
        
        // Sincronizar thumbnails con carrusel principal
        const syncThumbs = () => {
          const selected = emblaApi.selectedScrollSnap();
          thumbsEmblaApi.scrollTo(selected);
          
          // Actualizar estado visual de los thumbnails
          const thumbs = emblaNode.querySelectorAll('.embla-thumbs__slide');
          thumbs.forEach((thumb, index) => {
            if (index === selected) {
              thumb.classList.add('embla-thumbs__slide--selected');
            } else {
              thumb.classList.remove('embla-thumbs__slide--selected');
            }
          });
        };
        
        // Click en thumbnails
        const thumbs = emblaNode.querySelectorAll('.embla-thumbs__slide');
        thumbs.forEach((thumb, index) => {
          thumb.addEventListener('click', () => {
            emblaApi.scrollTo(index);
          }, false);
        });
        
        emblaApi.on('select', syncThumbs);
        syncThumbs();
      }
      
      emblaApi
        .on('select', () => {
          const disablePrev = !emblaApi.canScrollPrev();
          const disableNext = !emblaApi.canScrollNext();
          setupPrevNextBtns(disablePrev, disableNext);
        })
        .on('init', () => {
          const disablePrev = !emblaApi.canScrollPrev();
          const disableNext = !emblaApi.canScrollNext();
          setupPrevNextBtns(disablePrev, disableNext);
        });
    });
  }
</script>

<style>
  .embla {
    position: relative;
    --slide-spacing: 0.25rem;
    --slide-size: 100%;
    --slide-height: 400px;
  }
  
  .embla__viewport {
    overflow: hidden;
    width: 100%;
    border-radius: 0.5rem;
    margin: 0;
  }
  
  .embla__container {
    display: flex;
    touch-action: pan-y pinch-zoom;
    will-change: transform;
  }
  
  .embla__slide {
    flex: 0 0 var(--slide-size);
    min-width: 0;
    padding-left: var(--slide-spacing);
    padding-right: var(--slide-spacing);
  }
  
  .embla__slide__inner {
    position: relative;
    border-radius: 0.5rem;
    border: none;
    background: white;
    min-height: 350px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }
  
  .embla__slide__img {
    display: block;
    width: 100%;
    height: 100%;
    max-height: 450px;
    object-fit: contain;
  }
  
  .embla__button {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    z-index: 1;
    width: 2.5rem;
    height: 2.5rem;
    border: none;
    border-radius: 50%;
    background-color: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(4px);
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }
  
  .embla__button:hover {
    background-color: rgba(255, 255, 255, 0.95);
    transform: translateY(-50%) scale(1.05);
  }
  
  .embla__button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  
  .embla__button:disabled:hover {
    transform: translateY(-50%) scale(1);
  }
  
  .embla__button--prev {
    left: 0.75rem;
  }
  
  .embla__button--next {
    right: 0.75rem;
  }
  
  .embla__button__svg {
    width: 1.25rem;
    height: 1.25rem;
    stroke: currentColor;
    stroke-width: 2;
  }
  
  /* Thumbnails */
  .embla-thumbs {
    margin-top: 1rem;
  }
  
  .embla-thumbs__viewport {
    overflow: hidden;
  }
  
  .embla-thumbs__container {
    display: flex;
    flex-direction: row;
    margin-left: calc(var(--slide-spacing) * -1);
    margin-right: calc(var(--slide-spacing) * -1);
  }
  
  .embla-thumbs__slide {
    flex: 0 0 5rem;
    min-width: 0;
    padding-left: calc(var(--slide-spacing) * 0.25);
    padding-right: calc(var(--slide-spacing) * 0.25);
    position: relative;
  }
  
  .embla-thumbs__slide--selected {
    opacity: 1;
  }
  
  .embla-thumbs__slide:not(.embla-thumbs__slide--selected) {
    opacity: 0.5;
  }
  
  .embla-thumbs__slide__img {
    display: block;
    width: 100%;
    height: 5rem;
    object-fit: cover;
    border-radius: 0.375rem;
    border: 2px solid transparent;
    transition: all 0.2s ease;
  }
  
  .embla-thumbs__slide--selected .embla-thumbs__slide__img {
    border-color: rgb(236 72 153);
    box-shadow: 0 0 0 2px rgb(251 207 232);
  }
  
  /* Responsive */
  @media (max-width: 768px) {
    .embla__slide__img {
      max-height: 600px;
    }
    
    .embla__button {
      width: 2rem;
      height: 2rem;
    }
    
    .embla__button--prev {
      left: 0.5rem;
    }
    
    .embla__button--next {
      right: 0.5rem;
    }
    
    .embla__button__svg {
      width: 1rem;
      height: 1rem;
    }
    
    .embla-thumbs__slide {
      flex: 0 0 4rem;
    }
    
    .embla-thumbs__slide__img {
      height: 4rem;
    }
  }
  
  @media (max-width: 480px) {
    .embla {
      --slide-spacing: 0.5rem;
    }
    
    .embla__slide__img {
      max-height: 500px;
    }
    
    .embla-thumbs__slide {
      flex: 0 0 3rem;
    }
    
    .embla-thumbs__slide__img {
      height: 3rem;
    }
  }
</style>
