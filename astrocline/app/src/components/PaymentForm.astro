---
// PaymentForm.astro - Formulario completo de MercadoPago
export interface Props {
	amount: string;
	description?: string;
}

const { amount, description = 'Compra Rosita Rococo' } = Astro.props;
---

<section class="mb-6">
	<!-- Título del método de pago -->
	<div class="mb-4">
		<h5 class="font-bold text-gray-800 text-lg">
			<u>Tarjeta de crédito/débito:</u>
		</h5>
	</div>

	<!-- Formulario de MercadoPago -->
	<form 
		action="/process_payment" 
		method="post" 
		id="paymentForm"
		class="space-y-4"
	>
		<!-- Datos del comprador -->
		<div class="bg-gray-50 p-4 rounded-lg space-y-3">
			<h6 class="font-semibold text-gray-800 mb-2">Detalle del comprador</h6>
			
			<div>
				<label for="email" class="block text-sm font-medium text-gray-700 mb-1">
					Email
				</label>
				<input 
					id="email" 
					name="email" 
					type="email" 
					value="test@test.com"
					class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
					required
				/>
			</div>

			<div>
				<label for="docType" class="block text-sm font-medium text-gray-700 mb-1">
					Tipo de documento
				</label>
				<select 
					id="docType" 
					name="docType" 
					data-checkout="docType"
					class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
					required
				>
				</select>
			</div>

			<div>
				<label for="docNumber" class="block text-sm font-medium text-gray-700 mb-1">
					Número de documento
				</label>
				<input 
					id="docNumber" 
					name="docNumber" 
					data-checkout="docNumber" 
					type="text" 
					value="77882564044"
					class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
					required
				/>
			</div>
		</div>

		<!-- Datos del tarjeta -->
		<div class="bg-gray-50 p-4 rounded-lg space-y-3">
			<h6 class="font-semibold text-gray-800 mb-2">Detalles del tarjeta</h6>
			
			<div>
				<label for="cardholderName" class="block text-sm font-medium text-gray-700 mb-1">
					Titular del tarjeta
				</label>
				<input 
					id="cardholderName" 
					data-checkout="cardholderName" 
					type="text" 
					value="APRO"
					class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
					required
				/>
			</div>

			<div>
				<label class="block text-sm font-medium text-gray-700 mb-1">
					Fecha de vencimiento
				</label>
				<div id="cardExpirationDate" class="w-full"></div>
			</div>

			<div>
				<label class="block text-sm font-medium text-gray-700 mb-1">
					Número del tarjeta
				</label>
				<div id="cardNumber" class="w-full"></div>
			</div>

			<div>
				<label class="block text-sm font-medium text-gray-700 mb-1">
					Código de seguridad
				</label>
				<div id="securityCode" class="w-full"></div>
			</div>

			<div id="issuerInput">
				<label for="issuer" class="block text-sm font-medium text-gray-700 mb-1">
					Banco emisor
				</label>
				<select 
					id="issuer" 
					name="issuer" 
					data-checkout="issuer"
					class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
				>
				</select>
			</div>

			<div>
				<label for="installments" class="block text-sm font-medium text-gray-700 mb-1">
					Cuotas
				</label>
				<select 
					id="installments" 
					name="installments"
					class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
				>
				</select>
			</div>

			<!-- Campos ocultos -->
			<input 
				type="hidden" 
				name="transactionAmount" 
				id="transactionAmount" 
				value={amount} 
			/>
			<input 
				type="hidden" 
				name="paymentMethodId" 
				id="paymentMethodId" 
			/>
			<input 
				type="hidden" 
				name="description" 
				id="description" 
				value={description} 
			/>
		</div>

		<!-- Botón de pago -->
		<button 
			type="submit"
			class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200 shadow-lg hover:shadow-xl transform hover:scale-105"
		>
			Pagar ahora
		</button>
	</form>

	<!-- Instrucciones -->
	<div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mt-4">
		<p class="text-blue-800 text-sm">
			<strong>Importante:</strong> Toca el botón azul arriba para ir a pagar con cualquier tarjeta de crédito o débito en la plataforma segura de Mercadopago. Podrás elegir 1 pago o en cuotas sin interés. Luego de pagar recibirás un email desde Mercadopago confirmando tu pago.
		</p>
	</div>
</section>

<!-- MercadoPago SDK -->
<script src="https://sdk.mercadopago.com/js/v2"></script>

<script>
	// Inicialización de MercadoPago
	const mp = new MercadoPago("APP_USR-3dec33cf-193c-4dcc-a85c-d850bf083a09");

	// Montar campos PCI en las divs correspondientes
	const cardNumberElement = mp.fields.create('cardNumber', {
		placeholder: "Número del tarjeta"
	}).mount('cardNumber');

	const expirationDateElement = mp.fields.create('expirationDate', {
		placeholder: "MM/YY",
	}).mount('cardExpirationDate');

	const securityCodeElement = mp.fields.create('securityCode', {
		placeholder: "Código de seguridad"
	}).mount('securityCode');

	// Obtener tipos de documento
	(async function getIdentificationTypes() {
		try {
			const identificationTypes = await mp.getIdentificationTypes();
			const identificationTypeElement = document.getElementById('docType');
			createSelectOptions(identificationTypeElement, identificationTypes);
		} catch (e) {
			console.error('Error getting identificationTypes: ', e);
		}
	})();

	function createSelectOptions(elem, options, labelsAndKeys = { label: "name", value: "id" }) {
		const { label, value } = labelsAndKeys;
		elem.options.length = 0;
		const tempOptions = document.createDocumentFragment();

		options.forEach(option => {
			const optValue = option[value];
			const optLabel = option[label];
			const opt = document.createElement('option');
			opt.value = optValue;
			opt.textContent = optLabel;
			tempOptions.appendChild(opt);
		});

		elem.appendChild(tempOptions);
	}

	// Detectar método de pago cuando cambia el bin
	cardNumberElement.on('binChange', guessPaymentMethod);

	async function guessPaymentMethod(data) {
		const { bin } = data;
		const { results } = await mp.getPaymentMethods({ bin });
		await setPaymentMethod(results[0].id, bin);
	}

	async function setPaymentMethod(paymentMethodId, bin) {
		document.getElementById('paymentMethodId').value = paymentMethodId;
		await getIssuers(paymentMethodId, bin);
	}

	async function getIssuers(paymentMethodId, bin) {
		try {
			const issuers = await mp.getIssuers({ paymentMethodId, bin });
			setIssuers(issuers, bin);
		} catch (e) {
			console.error('Error getting issuers: ', e);
		}
	}

	function setIssuers(issuers, bin) {
		let issuerSelect = document.getElementById('issuer');
		issuerSelect.innerHTML = ''; // Limpiar opciones anteriores
		
		issuers.forEach(issuer => {
			let opt = document.createElement('option');
			opt.text = issuer.name;
			opt.value = issuer.id;
			issuerSelect.appendChild(opt);
		});

		getInstallments(bin);
	}

	async function getInstallments(bin) {
		try {
			const installments = await mp.getInstallments({
				amount: document.getElementById('transactionAmount').value,
				bin,
				paymentTypeId: 'credit_card'
			});
			setInstallments(installments);
		} catch (e) {
			console.error('Error getting installments: ', e);
		}
	}

	function setInstallments(installments) {
		const installmentsSelect = document.getElementById('installments');
		installmentsSelect.innerHTML = ''; // Limpiar opciones anteriores
		
		if (installments.length > 0 && installments[0].payer_costs) {
			installments[0].payer_costs.forEach(payerCost => {
				let opt = document.createElement('option');
				opt.text = payerCost.recommended_message;
				opt.value = payerCost.installments;
				installmentsSelect.appendChild(opt);
			});
		}
	}

	// Manejo del envío del formulario
	let doSubmit = false;
	document.getElementById('paymentForm').addEventListener('submit', getCardToken);

	async function getCardToken(event) {
		event.preventDefault();
		
		if (!doSubmit) {
			try {
				const token = await mp.fields.createCardToken({
					cardholderName: document.getElementById('cardholderName').value,
					identificationType: document.getElementById('docType').value,
					identificationNumber: document.getElementById('docNumber').value,
				});
				setCardTokenAndPay(token.id);
			} catch (e) {
				console.error('Error creating card token: ', e);
				alert('Error al procesar el pago. Por favor, verifica los datos de tu tarjeta.');
			}
		}
	}

	function setCardTokenAndPay(token) {
		let form = document.getElementById('paymentForm');
		let card = document.createElement('input');
		card.setAttribute('name', 'token');
		card.setAttribute('type', 'hidden');
		card.setAttribute('value', token);
		form.appendChild(card);
		doSubmit = true;
		form.submit();
	}
</script>
