<!DOCTYPE html>
<html>
<head>
<!-- Facebook Pixel Code -->
<script>
!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '1052677351596434');
fbq('track', 'PageView');
</script>
<noscript><img height="1" width="1" style="display:none"
src="https://www.facebook.com/tr?id=1052677351596434&ev=PageView&noscript=1"
/></noscript>
<!-- End Facebook Pixel Code -->
<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-W2CVWDJ');</script>
<!-- End Google Tag Manager -->
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>&iquest;C&oacute;mo comprar?</title>
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<link href="https://stefano.brilli.me/google-forms-html-exporter/styles/vendor.css" rel="stylesheet" />
	<link href="https://stefano.brilli.me/google-forms-html-exporter/styles/main.css" rel="stylesheet" />
	<style type="text/css">img {max-width:100%;}
      form {max-width:400px;     padding: 0px 5px;}
      button, html input[type=button], input[type=reset], input[type=submit] {margin-bottom: 10px; font-size: 20px; width: 100%;}
    .checkbox label, .radio label {padding-left:0px;}
    .checkbox-inline input[type=checkbox], .checkbox input[type=checkbox], .radio-inline input[type=radio], .radio input[type=radio] { margin-left: 0px; width: 30px; height: 30px; margin: 5px 280px;}
      input[type="checkbox"]:checked { box-shadow: 0 0 0 5px yellow;}
      input[type="checkbox"]:checked+img { box-shadow: 0 0 0 5px yellow;}
     ::placeholder { /* Chrome, Firefox, Opera, Safari 10.1+ */
  color: #777;
  opacity: 1; /* Firefox */
}

:-ms-input-placeholder { /* Internet Explorer 10-11 */
  color: #777;
}

::-ms-input-placeholder { /* Microsoft Edge */
  color: #777;
}

.myButton {
    -moz-box-shadow: inset 0px 1px 0px 0px #54a3f7;
    -webkit-box-shadow: inset 0px 1px 0px 0px #54a3f7;
    box-shadow: inset 0px 1px 0px 0px #54a3f7;
    background: -webkit-gradient(linear, left top, left bottom, color-stop(0.05, #007dc1), color-stop(1, #0061a7));
    background: -moz-linear-gradient(top, #007dc1 5%, #0061a7 100%);
    background: -webkit-linear-gradient(top, #007dc1 5%, #0061a7 100%);
    background: -o-linear-gradient(top, #007dc1 5%, #0061a7 100%);
    background: -ms-linear-gradient(top, #007dc1 5%, #0061a7 100%);
    background: linear-gradient(to bottom, #007dc1 5%, #0061a7 100%);
    filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#007dc1', endColorstr='#0061a7',GradientType=0);
    background-color: #3483fa;
    -moz-border-radius: 3px;
    -webkit-border-radius: 3px;
    border-radius: 3px;
    border: #3483fa;
    display: inline-block;
    cursor: pointer;
    color: #ffffff;
    font-family: Arial;
    text-align: center;
    font-size: 20px;
    width: 100%;
    padding: 5px 24px;
    text-decoration: none;
    text-shadow: 0px 1px 0px #3483fa;
}
.myButton:hover {
	background:-webkit-gradient(linear, left top, left bottom, color-stop(0.05, #0061a7), color-stop(1, #007dc1));
	background:-moz-linear-gradient(top, #0061a7 5%, #007dc1 100%);
	background:-webkit-linear-gradient(top, #0061a7 5%, #007dc1 100%);
	background:-o-linear-gradient(top, #0061a7 5%, #007dc1 100%);
	background:-ms-linear-gradient(top, #0061a7 5%, #007dc1 100%);
	background:linear-gradient(to bottom, #0061a7 5%, #007dc1 100%);
	filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#0061a7', endColorstr='#007dc1',GradientType=0);
	background-color:#0061a7;
}
.myButton:active {
	position:relative;
	top:1px;
}
	</style>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.form/4.2.2/jquery.form.min.js" integrity="sha256-2Pjr1OlpZMY6qesJM68t2v39t+lMLvxwpa8QlRjJroA=" crossorigin="anonymous"></script>
</head>
<body style="cursor: auto;background-color:white;">
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-W2CVWDJ"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
<div style="max-width: 400px; padding: 0px 5px;">
<p><img alt="" src="rosita-form.png" /></p>


<h4 style="text-align: center;"><strong><span style="font-size:22px;"><span style="background-color:#FFFF00;">PAG&Aacute; TU PEDIDO AHORA</span></span></strong></h4>

<div style="padding:10px; background-color: lightyellow; margin: auto;border:1px solid lightgrey;"><span id="talleselegidos"></span></div>

<p style="margin-top:20px;"><span style="color:#000000;"><span style="font-size:14px;"><u><strong>Transferencia Bancaria:</strong></u></span></span></p>

<p>Banco Santander<br>
  Número de CBU: 0720570588000035387718<br>
  Alias de CBU: RROCOCO.S<br>
  Titular de la cuenta: Baustian Roxana<br>
</p>

<p style="margin-top: 35px;">Pag&aacute; y mandanos una foto del ticket de pago.</p>

<p>Pag&aacute; <strong>$63.000</strong> por 1 par. El env&iacute;o es GRATIS en todos los casos.</p>

<p>Luego de pagar mandanos&nbsp;foto del ticket de pago <a href="http://bit.ly/wspb-rosita">por Whatsapp tocando aqu&iacute; &gt;</a></p>

<p>Sin la foto del comprobante de transferencia de pago tu pedido NO se procesa.</p>

<p>&iexcl;Gracias! Aguardamos tu PAGO y tu AVISO por Whatsapp para despachar!!<br />
Whatsapp aqu&iacute; =&gt; <a href="http://bit.ly/wspb-rosita" style="background-color: rgb(252, 252, 252);">http://bit.ly/wspb-rosita</a></p>

</div>
<script>
// Get order details from sessionStorage instead of URL parameters
var talleselegidos = sessionStorage.getItem('orderDetails') || '';
$("#talleselegidos").replaceWith(talleselegidos);

// If no data in sessionStorage, try legacy URL parameter method as fallback
if (!talleselegidos) {
    var getUrlParameter = function getUrlParameter(sParam) {
        var sPageURL = window.location.search.substring(1),
            sURLVariables = sPageURL.split('&'),
            sParameterName,
            i;

        for (i = 0; i < sURLVariables.length; i++) {
            sParameterName = sURLVariables[i].split('=');

            if (sParameterName[0] === sParam) {
                return sParameterName[1] === undefined ? true : decodeURIComponent(sParameterName[1]);
            }
        }
    };

    talleselegidos = getUrlParameter('entry.1471599855') || '';
    $("#talleselegidos").replaceWith(talleselegidos);
}

// Display customer name if available
var customerName = sessionStorage.getItem('customerName');
if (customerName) {
    var greetingElement = document.createElement('p');
    greetingElement.innerHTML = '¡Gracias por tu compra, <strong>' + customerName + '</strong>!';
    greetingElement.style.textAlign = 'center';
    greetingElement.style.marginTop = '10px';
    document.querySelector('.form-group, #talleselegidos').parentNode.insertBefore(greetingElement, document.querySelector('.form-group, #talleselegidos').nextSibling);
}

// Facebook Pixel Purchase Event - CBU 1 Par
(function() {
    // Función para generar Event ID único
    function generateEventId() {
        return 'fb_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    // Función auxiliar para obtener cookies
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return '';
    }

    // Función para establecer cookies
    function setCookie(name, value, days) {
        const expires = new Date();
        expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
        document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/;SameSite=Lax`;
    }

    // Función para obtener parámetro de URL
    function getUrlParameter(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
    }

    // Función para generar y gestionar FBC (Facebook Click ID)
    function generateFBC() {
        let fbc = getCookie('_fbc');

        // Si no existe FBC, intentar crearlo desde fbclid guardado o URL
        if (!fbc) {
            // Primero intentar desde localStorage (fbclid guardado de visita inicial)
            const savedFbclid = localStorage.getItem('initial_fbclid');
            let fbclid = savedFbclid || getUrlParameter('fbclid');

            if (fbclid) {
                // Usar el timestamp original guardado, o crear uno nuevo si no existe
                const savedTimestamp = localStorage.getItem('initial_fbclid_timestamp');
                const timestamp = savedTimestamp || Math.floor(Date.now() / 1000);

                // Si no teníamos timestamp guardado, guardarlo ahora
                if (!savedTimestamp) {
                    localStorage.setItem('initial_fbclid_timestamp', timestamp);
                    console.log('✅ Timestamp guardado para páginas futuras:', timestamp);
                }

                // Formato: fb.1.timestamp.fbclid (usando timestamp original)
                fbc = `fb.1.${timestamp}.${fbclid}`;
                setCookie('_fbc', fbc, 90); // Guardar por 90 días
                console.log('✅ FBC generado desde fbclid con timestamp original:', fbc);
            }
        }

        return fbc || '';
    }

    // Función para generar y gestionar FBP (Facebook Browser ID)
    function generateFBP() {
        let fbp = getCookie('_fbp');

        // Si no existe FBP, generarlo
        if (!fbp) {
            // Formato: fb.1.timestamp.random
            const timestamp = Math.floor(Date.now() / 1000);
            const random = Math.random().toString(36).substr(2, 9);
            fbp = `fb.1.${timestamp}.${random}`;
            setCookie('_fbp', fbp, 90); // Guardar por 90 días
            console.log('✅ FBP generado:', fbp);
        }

        return fbp;
    }

    // Función para obtener FBC/FBP con generación automática
    function getFacebookParams() {
        return {
            fbc: generateFBC() || localStorage.getItem('facebook_fbc') || '',
            fbp: generateFBP() || localStorage.getItem('facebook_fbp') || ''
        };
    }

    // Función para obtener timestamp correcto para Argentina (UTC-3)
    function getArgentinaTimestamp() {
        const now = new Date();
        const argentinaTime = new Date(now.getTime() - (3 * 60 * 60 * 1000));
        return Math.floor(argentinaTime.getTime() / 1000);
    }

    // Función para obtener la IP del cliente
    async function getClientIP() {
        try {
            const response = await fetch('https://api.ipify.org?format=json');
            const data = await response.json();
            return data.ip;
        } catch (error) {
            try {
                const response2 = await fetch('https://httpbin.org/ip');
                const data2 = await response2.json();
                return data2.origin;
            } catch (error2) {
                return '';
            }
        }
    }

    // Función para hashear email con SHA-256 (requerido por Meta)
    async function hashEmail(email) {
        if (!email) return '';
        const normalizedEmail = email.toLowerCase().trim();
        const encoder = new TextEncoder();
        const data = encoder.encode(normalizedEmail);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        return hashHex;
    }

    // Función para obtener email del localStorage
    function getStoredEmail() {
        return localStorage.getItem('customer_email') || '';
    }

    // Función de envío dual para Purchase
    async function sendPurchaseEvent() {
        // Verificar si ya se envió este evento (para evitar duplicados en recargas)
        const purchaseSent = sessionStorage.getItem('purchase_event_sent');
        if (purchaseSent === 'true') {
            console.log('✅ Evento Purchase ya fue enviado anteriormente, evitando duplicación');
            return;
        }

        // Generar un ID único para esta transacción
        const eventId = generateEventId();

        // Marcar como enviado para evitar duplicados en recargas
        sessionStorage.setItem('purchase_event_sent', 'true');
        sessionStorage.setItem('purchase_event_id', eventId);

        // Datos del evento Purchase - CBU 1 Par ($63.000)
        const eventData = {
            content_type: 'product',
            content_ids: ['1-par-cbu'],
            contents: [{
                id: '1-par-cbu',
                quantity: 1,
                item_price: 63000
            }],
            value: 63000,
            currency: 'ARS',
            num_items: 1
        };

        // 1. Enviar a Facebook (Cliente)
        /*
        if (typeof fbq !== 'undefined') {
            fbq('track', 'Purchase', {
                ...eventData,
                event_id: eventId
            });
        }
        */

        // 2. Obtener parámetros de Facebook (FBC/FBP) con generación automática
        const fbParams = getFacebookParams();

        // 3. Obtener la IP del cliente
        const clientIP = await getClientIP();

        // 4. Obtener y hashear email del cliente
        const customerEmail = getStoredEmail();
        const hashedEmail = await hashEmail(customerEmail);

        // 5. Preparar payload para Facebook Events API (formato N8N)
        const facebookEventData = {
            event_name: 'Purchase',
            event_id: eventId,
            event_time: getArgentinaTimestamp(), // Timestamp correcto para Argentina
            action_source: 'website',
            event_source_url: window.location.href,
            user_data: {
                client_ip_address: clientIP, // IP del cliente obtenida
                client_user_agent: navigator.userAgent,
                em: hashedEmail, // Email hasheado con SHA-256 (requerido por Meta)
                fbc: fbParams.fbc,
                fbp: fbParams.fbp
            },
            custom_data: eventData
        };

        // 3. Enviar al webhook (Servidor)
        try {
            await fetch('https://sswebhookss.odontolab.co/webhook/9dfb840b-2a21-4277-8aec-1666bfaaac89', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    data: [facebookEventData] // Array con el evento, listo para Facebook Events API
                })
            });
            console.log('✅ Purchase CBU enviado al servidor - FBC:', fbParams.fbc, 'FBP:', fbParams.fbp);
        } catch (error) {
            // Error silencioso
            console.error('Error enviando Purchase CBU al servidor:', error);
        }
    }

    // Ejecutar cuando la página esté cargada
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', sendPurchaseEvent);
    } else {
        sendPurchaseEvent();
    }
})();
</script>
<script>
(function() {
    // 🔐 VALIDACIÓN ROBUSTA DE TOKEN DE COMPRA
    const token = localStorage.getItem('valid_purchase_token');
    const tokenTime = parseInt(localStorage.getItem('purchase_timestamp'), 10);
    const now = Date.now();
    const maxAge = 15 * 60 * 1000; // 15 minutos (extendido para consistencia)

    if (!token || !tokenTime || (now - tokenTime) > maxAge) {
        console.log('❌ Bloqueado: Token de compra inválido, ausente o expirado.');
        return;
    }

    if (sessionStorage.getItem('purchase_sent_' + token) === 'true') {
        console.log('❌ Bloqueado: Este evento de compra ya se envió en esta sesión.');
        return;
    }

    console.log('✅ Validaciones superadas. Disparando evento Purchase...');

    // Dispara el evento Purchase
    sendPurchaseEvent();

    // Marcar como enviado y limpiar tokens
    sessionStorage.setItem('purchase_sent_' + token, 'true');
    localStorage.removeItem('valid_purchase_token');
    localStorage.removeItem('purchase_timestamp');
})();
</script>
</body>
</html>
