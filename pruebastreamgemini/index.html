<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sofía - Asistente Virtual</title>
    <style>
        :root {
            --primary-color: #E91E63;
            --secondary-color: #F8BBD0;
            --background-color: #f5f5f5;
            --text-color: #333;
            --assistant-bg: #fff;
            --user-bg: #E1F5FE;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
        body {
            margin: 0;
            font-family: var(--font-family);
            background-color: var(--background-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--text-color);
        }
        .chat-container {
            width: 100%;
            max-width: 800px;
            height: 90vh;
            max-height: 800px;
            background-color: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 16px 24px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: 600;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            flex-shrink: 0;
        }
        .messages {
            flex-grow: 1;
            padding: 24px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        .message {
            display: flex;
            margin-bottom: 16px;
            max-width: 80%;
        }
        .message .bubble {
            padding: 12px 18px;
            border-radius: 20px;
            line-height: 1.5;
        }
        .message.assistant {
            align-self: flex-start;
        }
        .message.assistant .bubble {
            background-color: var(--assistant-bg);
            border: 1px solid #eee;
            border-top-left-radius: 4px;
        }
        .message.user {
            align-self: flex-end;
        }
        .message.user .bubble {
            background-color: var(--user-bg);
            border-top-right-radius: 4px;
        }
        .status-bar {
            padding: 8px 24px;
            font-style: italic;
            color: #888;
            height: 20px;
            text-align: center;
            flex-shrink: 0;
            font-size: 0.9rem;
        }
        .controls {
            padding: 24px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #fff;
            flex-shrink: 0;
        }
        #mic-button {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            border: none;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(233, 30, 99, 0.4);
        }
        #mic-button:hover:not(:disabled) {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(233, 30, 99, 0.5);
        }
        #mic-button.recording {
            background-color: #F44336;
            animation: pulse 1.5s infinite;
        }
        #mic-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }
        #mic-button svg {
            width: 32px;
            height: 32px;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(244, 67, 54, 0); }
            100% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0); }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <header>Habla con Sofía</header>
        <div class="messages" id="messages">
            <!-- Los mensajes de chat aparecerán aquí -->
        </div>
        <div class="status-bar" id="status-bar">Presiona el micrófono para comenzar</div>
        <div class="controls">
            <button id="mic-button" title="Iniciar conversación">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"></path>
                    <path d="M17 11h-1c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92z"></path>
                </svg>
            </button>
        </div>
    </div>

    <script>
        // URL del WebSocket que apunta al subdominio dedicado.
        const PROXY_WEBSOCKET_URL = 'wss://sofia-proxy.odontolab.co/';
        const SYSTEM_INSTRUCTION = `Eres Sofía, una asistente de ventas de calzado amigable y muy eficiente para la marca "RositA RococO". Tu objetivo es tomar pedidos. Debes ser concisa y guiar al cliente paso a paso para obtener toda la información necesaria: nombre, teléfono, localidad, dirección, modelo, talle y método de pago (que por ahora es solo contrareembolso). Una vez que tengas TODOS los datos, y solo entonces, debes usar la herramienta 'registrar_pedido'. No confirmes el pedido hasta que la herramienta se haya ejecutado. Si el cliente pregunta por algo fuera de tu función, amablemente redirígelo a tomar su pedido.`;

        const micButton = document.getElementById('mic-button');
        const messagesContainer = document.getElementById('messages');
        const statusBar = document.getElementById('status-bar');

        let isRecording = false;
        let ws = null;
        let audioContext = null;
        let scriptProcessor = null;
        let mediaStreamSource = null;
        let audioStream = null;

        micButton.addEventListener('click', async () => {
            if (isRecording) {
                stopConversation();
            } else {
                await startConversation();
            }
        });

        function addMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', sender);
            const bubbleDiv = document.createElement('div');
            bubbleDiv.classList.add('bubble');
            bubbleDiv.textContent = text;
            messageDiv.appendChild(bubbleDiv);
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function startConversation() {
            micButton.disabled = true;
            updateStatus('Solicitando permiso del micrófono...', 'info');

            try {
                audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                updateStatus('Conectando con Sofía...', 'info');
                ws = await setupWebSocket();
                
                isRecording = true;
                micButton.classList.add('recording');
                micButton.title = 'Detener conversación';
                micButton.disabled = false;
                startAudioStreaming();
                addMessage("¡Hola! ¿Cómo puedo ayudarte a realizar tu pedido hoy?", "assistant");
                updateStatus('Habla ahora...', 'listening');

            } catch (error) {
                console.error('Error al iniciar la conversación:', error);
                const errorMessage = error instanceof Event ? "Fallo de conexión segura (SSL). Revisa el dominio y el firewall." : "No se pudo acceder al micrófono.";
                updateStatus(errorMessage, 'error');
                if (ws) ws.close();
                micButton.disabled = false;
            }
        }

        function stopConversation() {
            updateStatus('Terminando conversación...', 'info');
            isRecording = false;
            micButton.classList.remove('recording');
            micButton.title = 'Iniciar conversación';
            if (ws) {
                ws.close();
            }
            stopAudioStreaming();
        }

        function setupWebSocket() {
            return new Promise((resolve, reject) => {
                const socket = new WebSocket(PROXY_WEBSOCKET_URL);

                socket.onopen = () => {
                    console.log('WebSocket conectado.');
                    socket.send(JSON.stringify({
                        action: 'start',
                        systemInstruction: SYSTEM_INSTRUCTION
                    }));
                };

                socket.onmessage = (event) => {
                    const message = JSON.parse(event.data);
                    if (message.type === 'status' && message.message === 'connected') {
                        updateStatus('¡Conectado! Habla ahora...', 'listening');
                        resolve(socket);
                    } else if (message.type === 'gemini_response') {
                        handleGeminiResponse(message.data);
                    } else if (message.type === 'error') {
                        console.error('Error del servidor:', message.message);
                        updateStatus(`Error del servidor: ${message.message}`, 'error');
                    }
                };

                socket.onerror = (error) => {
                    console.error('Error en WebSocket:', error);
                    reject(error);
                };

                socket.onclose = (event) => {
                    console.log('WebSocket desconectado.', `Código: ${event.code}`, `Razón: ${event.reason}`);
                    stopConversation();
                    updateStatus('Conexión terminada. Presiona para volver a empezar.', 'info');
                };
            });
        }
        
        function handleGeminiResponse(data) {
            // Manejar transcripciones, respuestas de audio, etc.
            if (data.serverContent?.outputTranscription?.text) {
                // Por ahora, solo logueamos la transcripción de Sofía
                console.log("Sofía dijo:", data.serverContent.outputTranscription.text);
            }
            if(data.toolCall) {
                handleToolCall(data.toolCall);
            }
        }

        function handleToolCall(toolCall) {
            const functionCall = toolCall.functionCalls[0];
            if (functionCall.name === 'registrar_pedido') {
                console.log('EJECUTANDO HERRAMIENTA: registrar_pedido', functionCall.args);
                addMessage(`Pedido registrado para ${functionCall.args.nombre}. Nos contactaremos al ${functionCall.args.telefono} para coordinar el envío a ${functionCall.args.direccion}, ${functionCall.args.localidad}.`, 'assistant');
                
                // Enviar la respuesta de la herramienta de vuelta a Gemini
                ws.send(JSON.stringify({
                    action: 'tool_response',
                    response: {
                        id: functionCall.id,
                        name: functionCall.name,
                        response: { result: "OK, pedido registrado con éxito." }
                    }
                }));
            }
        }

        function startAudioStreaming() {
            if (!audioStream) return;
            
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            scriptProcessor = audioContext.createScriptProcessor(4096, 1, 1);
            mediaStreamSource = audioContext.createMediaStreamSource(audioStream);

            scriptProcessor.onaudioprocess = (event) => {
                if (!isRecording || !ws || ws.readyState !== WebSocket.OPEN) return;

                const inputData = event.inputBuffer.getChannelData(0);
                const l = inputData.length;
                const int16 = new Int16Array(l);
                for (let i = 0; i < l; i++) {
                    int16[i] = inputData[i] * 32767;
                }
                const base64 = btoa(String.fromCharCode.apply(null, new Uint8Array(int16.buffer)));
                
                ws.send(JSON.stringify({
                    action: 'audio_chunk',
                    chunk: {
                        data: base64,
                        mimeType: 'audio/pcm;rate=16000'
                    }
                }));
            };

            mediaStreamSource.connect(scriptProcessor);
            scriptProcessor.connect(audioContext.destination);
            console.log("Streaming de audio iniciado.");
        }

        function stopAudioStreaming() {
            if (mediaStreamSource) mediaStreamSource.disconnect();
            if (scriptProcessor) scriptProcessor.disconnect();
            if (audioContext) audioContext.close();
            if (audioStream) {
                audioStream.getTracks().forEach(track => track.stop());
            }
            mediaStreamSource = null;
            scriptProcessor = null;
            audioContext = null;
            audioStream = null;
            console.log("Streaming de audio detenido.");
        }

        function updateStatus(message, type = 'info') {
            statusBar.textContent = message;
            statusBar.style.color = type === 'error' ? '#D32F2F' : (type === 'listening' ? '#388E3C' : '#888');
        }

    </script>
</body>
</html>