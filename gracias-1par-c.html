<!DOCTYPE html>
<html lang="es">
<head>
    <!-- Google Tag Manager REMOVIDO - Ahora usando Facebook Pixel directo -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confirmaci√≥n de Pedido - Rosita Rococ√≥</title>
    <link rel="stylesheet" href="gracias-contrareembolso.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
</head>
<body>
    <!-- GTM noscript removido - Ahora usando Facebook Pixel directo -->

    <!-- Barra superior de beneficios -->
    <div class="top-benefits-bar">
        <div class="benefit-container">
            <div class="benefit-item">üí∏ PAGAS AL RECIBIR EN EFECTIVO</div>
            <div class="benefit-divider">|</div>
            <div class="benefit-item">üöö ENV√çO GRATIS</div>
        </div>
    </div>

    <div class="container">
        <header class="main-header">
            <img alt="Rosita Rococ√≥ Logo" src="rosita-form.webp" />
            <h1>Colecci√≥n Oto√±o-Invierno 2025</h1>
        </header>

        <h4><strong><span class="highlight">IMPORTANTE</span></strong></h4>

        <div id="customer-greeting" class="customer-greeting"></div>

        <p><strong>¬°√öLTIMO PASO!</strong> Toca el bot√≥n de WhatsApp para confirmar tu pedido. Sin este paso no podremos enviarlo.</p>

        <div class="whatsapp-button">
            <a id="wsplink" href="https://api.whatsapp.com/send?phone=5491127595502&text=Hola%20quiero%20confirmar%20mi%20pedido%20contrareembolso%20que%20reci%C3%A9n%20hice%3A%20">
                <img src="enviarwsp.png" alt="Enviar WhatsApp">
            </a>
        </div>

        <div class="order-details" id="talleselegidos"></div>

        <div class="payment-info">
            <p>Es importante tener en cuenta que debes contar con <strong>$60.000</strong> listos para el momento en que pase el delivery a dejar tu pedido para no demorar en la entrega por cuestiones de seguridad.</p>
        </div>

        <p class="thank-you">¬°Gracias por tu compra!</p>
    </div>
<script>
// Funci√≥n para obtener par√°metros de URL
var getUrlParameter = function getUrlParameter(sParam) {
    var sPageURL = window.location.search.substring(1),
        sURLVariables = sPageURL.split('&'),
        sParameterName,
        i;

    for (i = 0; i < sURLVariables.length; i++) {
        sParameterName = sURLVariables[i].split('=');

        if (sParameterName[0] === sParam) {
            return sParameterName[1] === undefined ? true : decodeURIComponent(sParameterName[1]);
        }
    }
    return '';
};

// Funci√≥n para procesar productos y generar detalles formateados
function procesarProductos(productos) {
    if (!productos) return '';

    var pairs = productos.split(', ').filter(Boolean);
    var values = [];

    for (var i = 0; i < pairs.length; i++) {
        var parts = pairs[i].split('-');
        if (parts.length < 2) continue;

        var talle = parts[0].trim();
        var modelo = parts[1];
        var color = parts.slice(2).join(' ');

        // Mapeo de c√≥digos de modelo a nombres legibles
        var modeloNombre;
        var modeloId;

        switch(modelo) {
            case 'roma':
                modeloNombre = 'Botineta Roma';
                modeloId = '#4016';
                break;
            case 'venecia':
                modeloNombre = 'Venecia';
                modeloId = '#4015';
                break;
            case 'siena':
                modeloNombre = 'Borcego Siena';
                modeloId = '#SIENA';
                break;
            case 'paris':
                modeloNombre = 'Paris';
                modeloId = '#PARIS';
                break;
            default:
                modeloNombre = modelo.charAt(0).toUpperCase() + modelo.slice(1);
                modeloId = 'desconocido';
                break;
        }

        // Agregar el color al nombre del modelo si existe
        if (color) {
            modeloNombre += ' ' + color;
        }

        var modelosangies = 'Talle: ' + talle + ' Modelo: ' + modeloNombre;
        values.push(modelosangies);
    }

    return values.join(' || ');
}

// Get order details from localStorage (primary) or sessionStorage (fallback)
var talleselegidos = localStorage.getItem('orderDetails') || sessionStorage.getItem('orderDetails') || '';
console.log('Datos recuperados de localStorage:', {
    orderDetails: localStorage.getItem('orderDetails'),
    rawProducts: localStorage.getItem('rawProducts'),
    customerName: localStorage.getItem('customerName')
});

if (talleselegidos) {
    $("#talleselegidos").html(talleselegidos);
    console.log('Usando detalles de localStorage:', talleselegidos);
} else {
    // Fallback to URL parameters if storage is empty
    var urlParams = getUrlParameter('286442883') || getUrlParameter('entry.1471599855') || '';
    if (urlParams) {
        // Procesar los productos para mostrar detalles formateados
        var detallesFormateados = procesarProductos(urlParams);
        if (detallesFormateados) {
            $("#talleselegidos").html(detallesFormateados);
            console.log('Detalles procesados de URL:', detallesFormateados);

            // Guardar en localStorage para futuras referencias
            localStorage.setItem('orderDetails', detallesFormateados);
            localStorage.setItem('rawProducts', urlParams);
        } else {
            // Si no se pueden procesar, mostrar los par√°metros crudos
            $("#talleselegidos").html(urlParams);
            console.log('Usando par√°metros crudos de URL:', urlParams);
        }
    } else {
        $("#talleselegidos").html('Detalles del pedido no disponibles');
        console.log('No se encontraron detalles del pedido');
    }
}

// Display customer name if available
var customerName = localStorage.getItem('customerName') || sessionStorage.getItem('customerName');
if (customerName) {
    $("#customer-greeting").html('¬°Gracias por tu compra, <strong>' + customerName + '</strong>!');
} else {
    $("#customer-greeting").hide();
}

// Limpiar localStorage despu√©s de mostrar los datos (para evitar problemas en futuras visitas)
// Dejamos un peque√±o retraso para asegurarnos de que los datos se muestren correctamente
setTimeout(function() {
    // No eliminamos los datos completamente para permitir que el usuario pueda actualizar la p√°gina
    // y seguir viendo los detalles de su pedido
    // localStorage.removeItem('orderDetails');
    // localStorage.removeItem('customerName');
}, 2000);

// Update WhatsApp link to include order details
var wspLink = document.getElementById('wsplink');
if (wspLink) {
    var detallesPedido = '';

    // Intentar obtener detalles de localStorage primero
    if (talleselegidos) {
        detallesPedido = talleselegidos;
    } else {
        // Si no hay detalles en localStorage, intentar obtenerlos de los par√°metros URL
        var urlParams = getUrlParameter('286442883') || getUrlParameter('entry.1471599855') || '';
        if (urlParams) {
            detallesPedido = procesarProductos(urlParams);
        }
    }

    // Obtener el nombre del cliente si est√° disponible
    var nombreCliente = localStorage.getItem('customerName') || sessionStorage.getItem('customerName') || '';

    // Construir el mensaje de WhatsApp
    var mensajeWhatsApp = 'Hola, quiero confirmar mi pedido contrareembolso que reci√©n hice';

    // Agregar el nombre si est√° disponible
    if (nombreCliente) {
        mensajeWhatsApp = 'Hola, soy ' + nombreCliente + ' y quiero confirmar mi pedido contrareembolso que reci√©n hice';
    }

    // Agregar los detalles del pedido si est√°n disponibles
    if (detallesPedido) {
        mensajeWhatsApp += '.\n\nDetalles del pedido: ' + detallesPedido;
    }

    var baseUrl = wspLink.href.split('?')[0];
    var newUrl = baseUrl + '?phone=5491127595502&text=' + encodeURIComponent(mensajeWhatsApp);
    wspLink.href = newUrl;

    console.log('URL de WhatsApp actualizada:', newUrl);
    console.log('Mensaje de WhatsApp:', mensajeWhatsApp);
}

// Facebook Pixel Purchase Event - Contrareembolso 1 Par
(function() {
    // Funci√≥n para generar Event ID √∫nico
    function generateEventId() {
        return 'fb_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    // Funci√≥n auxiliar para obtener cookies
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return '';
    }

    // Funci√≥n de env√≠o dual para Purchase
    async function sendPurchaseEvent() {
        const eventId = generateEventId();

        // Datos del evento Purchase - Contrareembolso 1 Par ($60.000)
        const eventData = {
            content_type: 'product',
            content_ids: ['1-par-contrareembolso'],
            contents: [{
                id: '1-par-contrareembolso',
                quantity: 1,
                item_price: 60000
            }],
            value: 60000,
            currency: 'ARS',
            num_items: 1
        };

        // 1. Enviar a Facebook (Cliente)
        if (typeof fbq !== 'undefined') {
            fbq('track', 'Purchase', {
                ...eventData,
                event_id: eventId
            });
        }

        // 2. Preparar payload completo de Facebook para N8N
        const facebookPayload = {
            pixel_id: '1052677351596434',
            event_name: 'Purchase',
            event_id: eventId,
            event_time: Math.floor(Date.now() / 1000),
            action_source: 'website',
            event_source_url: window.location.href,
            user_data: {
                client_ip_address: '',
                client_user_agent: navigator.userAgent,
                fbc: getCookie('_fbc') || '',
                fbp: getCookie('_fbp') || ''
            },
            custom_data: eventData
        };

        // 3. Enviar al webhook (Servidor)
        try {
            await fetch('https://sswebhookss.odontolab.co/webhook/9dfb840b-2a21-4277-8aec-1666bfaaac89', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    facebook_payload: facebookPayload,
                    debug_info: {
                        page_type: 'contrareembolso_1par',
                        timestamp: new Date().toISOString()
                    }
                })
            });
        } catch (error) {
            // Error silencioso
        }
    }

    // Ejecutar cuando la p√°gina est√© cargada
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', sendPurchaseEvent);
    } else {
        sendPurchaseEvent();
    }
})();
</script>
</body>
</html>
