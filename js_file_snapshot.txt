uid=5_0 RootWebArea url="http://localhost:3000/astrocline/js/carousel.js"
  uid=5_1 StaticText "// Variables globales para el carrito - Protecci√≥n contra cargas m√∫ltiples
if (typeof window.cart === 'undefined') {
    window.cart = [];
    window.cartCount = 0;
    window.isCartOpen = false;
}

// Usar referencias a las variables globales en lugar de redeclarar
// const cart = window.cart;  // REMOVED - This causes redeclaration
// const cartCount = window.cartCount;  // REMOVED - This causes redeclaration  
// const isCartOpen = window.isCartOpen;  // REMOVED - This causes redeclaration

// Productos disponibles
const products = {
    'negras': {
        name: 'Guillerminas Negras',
        price: 60000,
        image: '/guillerminafotos/1.webp'
    },
    'camel': {
        name: 'Guillerminas Camel', 
        price: 60000,
        image: '/guillerminafotos/guillerminascamel/1.webp'
    },
    'blancas': {
        name: 'Guillerminas Blancas',
        price: 60000,
        image: '/guillerminafotos/guillerminasblancas/1.webp'
    }
};

// Funci√≥n para agregar productos al carrito
function addToCart(model, size) {
    // Validar que se haya seleccionado un talle
    if (!size) {
        showCartMessage('Por favor selecciona un talle', 'warning');
        return;
    }

    const product = products[model];
    if (!product) {
        showCartMessage('Producto no encontrado', 'error');
        return;
    }

    // Validar l√≠mite de 2 pares por pedido
    if (window.cartCount >= 2) {
        showCartMessage('‚ö†Ô∏è L√≠mite alcanzado: Solo puedes agregar m√°ximo 2 pares por pedido', 'warning', 4000);
        return;
    }

    // Agregar producto al carrito
    const cartItem = {
        id: Date.now(),
        model: model,
        name: product.name,
        size: size,
        price: product.price,
        image: product.image
    };

    window.cart.push(cartItem);
    window.cartCount++;
    
    // Actualizar interfaz
    updateCartUI();
    
    // Mostrar mensaje contextual seg√∫n cantidad
    if (window.cartCount === 1) {
        showCartMessage('¬°Producto agregado! Agreg√° un segundo par y ahorr√° $25.000', 'success');

        // Mostrar modal de WhatsApp despu√©s de agregar el primer par
        // Verificar si el modal ya fue mostrado en esta sesi√≥n
        const whatsappModalShown = localStorage.getItem('whatsappModalShown');
        if (!whatsappModalShown) {
            setTimeout(() => {
                showWhatsAppModal();
            }, 2000); // Mostrar despu√©s de 2 segundos
        }
    } else if (window.cartCount === 2) {
        showCartMessage('üéâ ¬°Promoci√≥n activada! 2 pares por $95.000 (ahorraste $25.000)', 'success');
    }
    
    // Abrir carrito autom√°ticamente
    openCart();
    
    console.log('Producto agregado al carrito:', cartItem);
}

// Funci√≥n para eliminar un producto del carrito
function removeFromCart(itemId) {
    window.cart = window.cart.filter(item => item.id !== itemId);
    window.cartCount = window.cart.length;
    updateCartUI();
    
    // Mostrar mensaje si el carrito queda vac√≠o
    if (window.cartCount === 0) {
        showCartMessage('Carrito vac√≠o', 'info');
    } else if (window.cartCount === 1) {
        showCartMessage('Promoci√≥n desactivada. Agreg√° otro par para activar el descuento.', 'warning');
    } else {
        showCartMessage('Promoci√≥n activada. 2 pares por $95.000', 'success');
    }
    
    console.log('Producto eliminado del carrito. Items restantes:', window.cartCount);
}

// Funci√≥n para calcular el total del carrito
function calculateCartTotal() {
    if (window.cartCount === 0) return 0;
    if (window.cartCount === 1) return 60000;
    return window.cartCount * 47500; // Promoci√≥n 2x $95.000
}

// Funci√≥n para calcular el total con descuento de transferencia
function calculateCartTotalWithDiscount() {
    let baseTotal = calculateCartTotal();
    
    // Obtener m√©todo de pago seleccionado
    const paymentMethod = document.getElementById('comoabona');
    if (paymentMethod && paymentMethod.value === 'cbu') {
        // Aplicar 10% de descuento adicional para transferencia
        baseTotal = Math.round(baseTotal * 0.9);
    }
    
    return baseTotal;
}

// Funci√≥n para actualizar la interfaz del carrito
function updateCartUI() {
    // Actualizar contador
    const cartCountElements = document.querySelectorAll('.cart-count, .cart-button-count');
    cartCountElements.forEach(element => {
        element.textContent = window.cartCount;
    });

    // Actualizar items del carrito
    const cartItemsContainer = document.querySelector('.cart-items');
    const emptyMessage = document.querySelector('.empty-cart-message');
    
    if (window.cartCount === 0) {
        cartItemsContainer.innerHTML = '';
        if (emptyMessage) emptyMessage.style.display = 'block';
    } else {
        if (emptyMessage) emptyMessage.style.display = 'none';
        
        // Generar HTML de los items - BOT√ìN ELIMINAR A LA DERECHA DEL NOMBRE
        cartItemsContainer.innerHTML = window.cart.map(item => `
            <div class="cart-item bg-gray-50 p-3 rounded-lg relative" data-item-id="${item.id}">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3 flex-1">
                        <img src="${item.image}" alt="${item.name}" class="w-12 h-12 object-cover rounded">
                        <div>
                            <h4 class="font-semibold text-sm">${item.name}</h4>
                            <p class="text-xs text-gray-600">Talle: ${item.size}</p>
                        </div>
                    </div>
                    <button class="remove-item text-red-500 hover:text-red-700 text-xl font-bold w-6 h-6 rounded-full bg-white shadow-md z-10 flex-shrink-0" 
                            onclick="removeFromCart(${item.id})" title="Eliminar producto">
                        √ó
                    </button>
                </div>
            </div>
        `).join('');
    }

    // Actualizar total con descuento si corresponde
    const total = calculateCartTotalWithDiscount();
    const totalElements = document.querySelectorAll('.cart-total span');
    totalElements.forEach(element => {
        element.textContent = `$${total.toLocaleString('es-AR')}`;
    });

    // Actualizar estado del bot√≥n de checkout
    const checkoutBtn = document.getElementById('checkout-btn');
    if (checkoutBtn) {
        if (window.cartCount > 0) {
            checkoutBtn.disabled = false;
            checkoutBtn.className = 'bg-pink-600 text-white px-4 py-2 rounded-lg hover:bg-pink-700 transition-all duration-300 cursor-pointer';
        } else {
            checkoutBtn.disabled = true;
            checkoutBtn.className = 'bg-gray-400 text-white px-4 py-2 rounded-lg cursor-not-allowed';
        }
    }

    // Mostrar autom√°ticamente el formulario de checkout si hay items
    const checkoutSection = document.getElementById('restodelform');
    if (checkoutSection) {
        if (window.cartCount > 0) {
            checkoutSection.classList.remove('hidden');
            // Actualizar progreso del checkout
            updateCheckoutProgress(2);
            
            // Mostrar notificaci√≥n suave
            showCartMessage('üõí ¬°Carrito listo! Puedes continuar con tu compra.', 'info', 3000);
        } else {
            checkoutSection.classList.add('hidden');
        }
    }

    // Actualizar formulario de pedido
    updateOrderSummary();
}

// Funci√≥n para formatear datos del carrito para el funnel
function formatCartDataForFunnel() {
    if (window.cartCount === 0) return '';
    const formattedItems = window.cart.map(item => {
        const modelMap = {
            'negras': 'guillermina-negras',
            'camel': 'guillermina-camel',
            'blancas': 'guillermina-blancas'
        };
        const modelKey = modelMap[item.model] || item.model;
        return `${item.size}-${modelKey}`;
    });
    return formattedItems.join(', ');
}

// Funci√≥n para actualizar el resumen del pedido
function updateOrderSummary() {
    const summaryElement = document.getElementById('286442883');
    const reviewElement = document.getElementById('review-modelostallesseleccionados');

    if (window.cartCount > 0 && summaryElement) {
        const summaryText = window.cart.map(item => `${item.name} - Talle ${item.size}`).join(', ');
        summaryElement.value = summaryText;

        if (reviewElement) {
            reviewElement.textContent = summaryText;
        }

        // Actualizar campos ocultos con formato para funnel
        const funnelData = formatCartDataForFunnel();
        const hiddenFields = document.querySelectorAll('input[type="hidden"][name*="entry."]');
        hiddenFields.forEach(field => {
            if (field.value && field.id !== 'link-mercadopago' && field.id !== 'link-transferencia') {
                field.value = funnelData;
            }
        });
    } else {
        if (summaryElement) summaryElement.value = '';
        if (reviewElement) reviewElement.textContent = '-';
    }
    
    // Actualizar precio total en el resumen con descuento si corresponde
    const totalElement = document.getElementById('preciototal');
    if (totalElement) {
        const total = calculateCartTotalWithDiscount();
        if (window.cartCount > 0) {
            const paymentMethod = document.getElementById('comoabona');
            const isTransfer = paymentMethod && paymentMethod.value === 'cbu';
            
            if (isTransfer) {
                totalElement.innerHTML = `<strong>Total: $${total.toLocaleString('es-AR')} <span class="text-green-600 text-sm">(10% OFF por transferencia)</span></strong>`;
            } else {
                totalElement.innerHTML = `<strong>Total: $${total.toLocaleString('es-AR')}</strong>`;
            }
        } else {
            totalElement.textContent = 'Elige modelos y talles para ver el total';
        }
    }
}

// Funci√≥n para mostrar mensajes inline (modal dentro del contenido)
function showInlineMessage(message, type = 'info', duration = 5000) {
    // Crear modal overlay
    const modalOverlay = document.createElement('div');
    modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    modalOverlay.style.position = 'fixed';
    modalOverlay.style.top = '0';
    modalOverlay.style.left = '0';
    modalOverlay.style.right = '0';
    modalOverlay.style.bottom = '0';
    modalOverlay.style.zIndex = '9999';
    
    // Crear modal content
    const modalContent = document.createElement('div');
    modalContent.className = 'bg-white rounded-lg p-6 max-w-sm w-full shadow-2xl transform transition-all';
    
    let bgColor = 'bg-blue-100 border-blue-400 text-blue-800';
    let icon = '‚ÑπÔ∏è';
    
    switch(type) {
        case 'success':
            bgColor = 'bg-green-100 border-green-400 text-green-800';
            icon = '‚úÖ';
            break;
        case 'warning':
            bgColor = 'bg-yellow-100 border-yellow-400 text-yellow-800';
            icon = '‚ö†Ô∏è';
            break;
        case 'error':
            bgColor = 'bg-red-100 border-red-400 text-red-800';
            icon = '‚ùå';
            break;
    }
    
    modalContent.innerHTML = `
        <div class="${bgColor} border-l-4 p-4 rounded-lg">
            <div class="flex items-center">
                <span class="text-2xl mr-3">${icon}</span>
                <p class="flex-1 font-medium">${message}</p>
                <button onclick="this.closest('.fixed').remove()" 
                        class="ml-3 text-gray-500 hover:text-gray-700 text-xl font-bold">√ó
                </button>
            </div>
        </div>
    `;
    
    modalOverlay.appendChild(modalContent);
    document.body.appendChild(modalOverlay);
    
    // Auto cerrar despu√©s del tiempo especificado
    if (duration > 0) {
        setTimeout(() => {
            if (modalOverlay.parentNode) {
                modalOverlay.remove();
            }
        }, duration);
    }
    
    // Cerrar al hacer clic fuera
    modalOverlay.addEventListener('click', function(e) {
        if (e.target === modalOverlay) {
            modalOverlay.remove();
        }
    });
}

// Funci√≥n para mostrar mensajes en el carrito (mantenida para compatibilidad)
function showCartMessage(message, type = 'info', duration = 5000) {
    showInlineMessage(message, type, duration);
}

// Funci√≥n para abrir/cerrar el carrito
function toggleCart() {
    const miniCart = document.getElementById('mini-cart');
    if (!miniCart) return;
    
    window.isCartOpen = !window.isCartOpen;
    
    if (window.isCartOpen) {
        miniCart.style.transform = 'translateX(0)';
        miniCart.style.opacity = '1';
        miniCart.style.pointerEvents = 'auto';
    } else {
        miniCart.style.transform = 'translateX(100%)';
        miniCart.style.opacity = '0';
        miniCart.style.pointerEvents = 'none';
    }
}

function openCart() {
    const miniCart = document.getElementById('mini-cart');
    if (miniCart && !window.isCartOpen) {
        window.isCartOpen = true;
        miniCart.style.transform = 'translateX(0)';
        miniCart.style.opacity = '1';
        miniCart.style.pointerEvents = 'auto';
    }
}

function closeCart() {
    const miniCart = document.getElementById('mini-cart');
    if (miniCart && window.isCartOpen) {
        window.isCartOpen = false;
        miniCart.style.transform = 'translateX(100%)';
        miniCart.style.opacity = '0';
        miniCart.style.pointerEvents = 'none';
    }
}

// Funci√≥n para ir al formulario de checkout
function goToCheckoutForm() {
    if (window.cartCount === 0) {
        showCartMessage('Debes agregar productos antes de continuar', 'warning');
        return;
    }
    
    // Cerrar carrito
    closeCart();
    
    // Mostrar formulario de checkout
    const checkoutSection = document.getElementById('restodelform');
    const productsSection = document.getElementById('todoslosmodelos');
    
    if (checkoutSection && productsSection) {
        checkoutSection.classList.remove('hidden');
        checkoutSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
        // ActualizarËøõÂ∫¶Ê†è
        updateCheckoutProgress(2);
    }
    
    console.log('Navegando al formulario de checkout');
}

// Funci√≥n para actualizar el progreso del checkout
function updateCheckoutProgress(step) {
    const progressSteps = document.querySelectorAll('.progress-step');
    progressSteps.forEach((stepElement, index) => {
        const stepNumber = index + 1;
        const stepNumberEl = stepElement.querySelector('.step-number');
        const stepNameEl = stepElement.querySelector('.step-name');
        
        if (stepNumber < step) {
            // Pasos completados
            stepElement.classList.add('completed');
            stepNumberEl.className = 'step-number bg-green-600 text-white w-8 h-8 rounded-full flex items-center justify-center text-sm mr-2';
            stepNameEl.className = 'step-name text-sm font-medium text-green-600';
        } else if (stepNumber === step) {
            // Paso actual
            stepElement.classList.add('active');
            stepNumberEl.className = 'step-number bg-pink-600 text-white w-8 h-8 rounded-full flex items-center justify-center text-sm mr-2';
            stepNameEl.className = 'step-name text-sm font-medium';
        } else {
            // Pasos futuros
            stepElement.classList.remove('active', 'completed');
            stepNumberEl.className = 'step-number bg-gray-300 text-gray-600 w-8 h-8 rounded-full flex items-center justify-center text-sm mr-2';
            stepNameEl.className = 'step-name text-sm font-medium text-gray-600';
        }
    });
}

// Funci√≥n para volver a productos
function backToProducts() {
    const checkoutSection = document.getElementById('restodelform');
    const productsSection = document.getElementById('todoslosmodelos');
    
    if (checkoutSection && productsSection) {
        checkoutSection.classList.add('hidden');
        productsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
        // ActualizarËøõÂ∫¶Ê†è
        updateCheckoutProgress(1);
    }
}

// Funci√≥n para actualizar din√°micamente los campos de revisi√≥n
function updateReviewFields() {
    // Actualizar campos de contacto
    const nombreField = document.getElementById('1460904554');
    const whatsappField = document.getElementById('53830725');
    const emailField = document.getElementById('1465946249');
    const dniField = document.getElementById('541001873');
    
    // Actualizar campos de direcci√≥n
    const calleField = document.getElementById('951592426');
    const localidadField = document.getElementById('1743418466');
    const cpField = document.getElementById('1005165410');
    const provinciaField = document.getElementById('59648134');
    
    // Actualizar elementos de revisi√≥n
    const nombreReview = document.getElementById('help-nombre');
    const whatsappReview = document.getElementById('help-wapp');
    const emailReview = document.getElementById('help-email');
    const dniReview = document.getElementById('help-dni');
    const calleReview = document.getElementById('help-calleyaltura');
    const localidadReview = document.getElementById('help-localidad');
    const cpReview = document.getElementById('help-cp');
    const provinciaReview = document.getElementById('help-provincia');
    
    // Actualizar campos de contacto en tiempo real
    if (nombreField && nombreReview) {
        nombreReview.textContent = nombreField.value || '-';
    }
    
    if (whatsappField && whatsappReview) {
        whatsappReview.textContent = whatsappField.value || '-';
    }
    
    if (emailField && emailReview) {
        emailReview.textContent = emailField.value || '-';
    }
    
    if (dniField && dniReview) {
        dniReview.textContent = dniField.value || '-';
    }
    
    // Actualizar campos de direcci√≥n en tiempo real
    if (calleField && calleReview) {
        calleReview.textContent = calleField.value || '-';
    }
    
    if (localidadField && localidadReview) {
        localidadReview.textContent = localidadField.value || '-';
    }
    
    if (cpField && cpReview) {
        cpReview.textContent = cpField.value || '-';
    }
    
    if (provinciaField && provinciaReview) {
        const selectedOption = provinciaField.options[provinciaField.selectedIndex];
        provinciaReview.textContent = selectedOption ? selectedOption.text : '-';
    }
}

// Variable global para prevenir duplicados
let isProcessingAddToCart = false;

// Funci√≥n global para manejar clics en botones de agregar al carrito
function handleAddToCart(button) {
    console.log('üõí handleAddToCart called', button);
    
    // Prevenir m√∫ltiples clics simult√°neos
    if (isProcessingAddToCart) {
        console.log('‚ö†Ô∏è Ya se est√° procesando un agregado al carrito');
        return;
    }
    
    isProcessingAddToCart = true;
    
    try {
        const model = button.getAttribute('data-model');
        console.log('üì¶ Model:', model);
        
        const selectId = `talle-${model}`;
        console.log('üîç Looking for select ID:', selectId);
        
        // Buscar el select dentro del mismo product-card
        const productCard = button.closest('.product-card');
        let selectElement = null;
        
        if (productCard) {
            selectElement = productCard.querySelector(`#${selectId}`);
            console.log('üìã Select found in product card:', !!selectElement);
        } else {
            // Fallback: b√∫squeda global por ID
            selectElement = document.getElementById(selectId);
            console.log('üìã Select found globally:', !!selectElement);
        }
        
        if (selectElement) {
            console.log('üìä Select value:', selectElement.value);
            console.log('üìä Select selectedIndex:', selectElement.selectedIndex);
            
            // Resetear todos los otros selects para evitar confusiones
            const allSelects = document.querySelectorAll('select[id^="talle-"]');
            allSelects.forEach(select => {
                if (select.id !== selectId) {
                    console.log('üîÑ Resetting other select:', select.id);
                    select.selectedIndex = 0;
                }
            });
            
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            console.log('üìù Selected option:', selectedOption);
            
            const sizeText = selectedOption ? selectedOption.textContent.split(' (')[0] : '';
            console.log('üëü Size extracted:', sizeText);
            
            if (sizeText && sizeText !== '-- Selecciona Talle --') {
                addToCart(model, sizeText);
            } else {
                showCartMessage('Por favor selecciona un talle', 'warning');
                console.log('‚ö†Ô∏è Size validation failed');
            }
        } else {
            showCartMessage('Error: No se encontr√≥ el selector de talle', 'error');
            console.log('‚ùå Select element not found');
        }
    } finally {
        // Restablecer el flag despu√©s de un breve per√≠odo
        setTimeout(() => {
            isProcessingAddToCart = false;
        }, 500);
    }
}

// Funci√≥n para inicializar los eventos del carrito
function initializeCart() {
    // Event listeners para los botones de agregar al carrito
    const addToCartButtons = document.querySelectorAll('.add-to-cart-btn');
    addToCartButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            handleAddToCart(this);
        });
    });

    // Event listener para el bot√≥n del carrito
    const cartButton = document.getElementById('cart-button');
    if (cartButton) {
        cartButton.addEventListener('click', toggleCart);
    }

    // Event listener para cerrar el carrito
    const cartClose = document.querySelector('.cart-close');
    if (cartClose) {
        cartClose.addEventListener('click', closeCart);
    }

    // Event listener para volver a productos
    const backToProductsBtn = document.getElementById('back-to-products');
    if (backToProductsBtn) {
        backToProductsBtn.addEventListener('click', backToProducts);
    }

    // Event listener para el bot√≥n de checkout en el carrito
    const checkoutBtn = document.getElementById('checkout-btn');
    if (checkoutBtn) {
        checkoutBtn.addEventListener('click', goToCheckoutForm);
    }

    // Event listeners para actualizaci√≥n en tiempo real de campos de revisi√≥n
    const formFields = [
        '1460904554', '53830725', '1465946249', '541001873', // Contacto
        '951592426', '1743418466', '1005165410', '59648134' // Direcci√≥n
    ];
    
    formFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener('input', updateReviewFields);
            field.addEventListener('change', updateReviewFields);
        }
    });

    // Event listener para cambios en m√©todo de pago
    const paymentMethodSelect = document.getElementById('comoabona');
    if (paymentMethodSelect) {
        paymentMethodSelect.addEventListener('change', function() {
            updateOrderSummary(); // Actualizar precio cuando cambia el m√©todo de pago
        });
    }

    // Inicializar UI del carrito
    updateCartUI();
    
    // Inicializar campos de revisi√≥n
    updateReviewFields();
}

// Funci√≥n para inicializar los carruseles Embla con funcionalidad completa
function initializeSwipers() {
    console.log('üé† Inicializando carruseles Embla...');

    // Esperar a que la librer√≠a Embla est√© disponible
    if (typeof EmblaCarousel === 'undefined') {
        console.log('‚è≥ Esperando a que Embla Carousel se cargue...');
        setTimeout(initializeSwipers, 100);
        return;
    }

    try {
        // Inicializar cada carrusel de producto
        document.querySelectorAll('.embla').forEach(function(container) {
            const productId = container.dataset.productId;
            const viewport = container.querySelector('.embla__viewport');
            const thumbsViewport = container.querySelector('.embla-thumbs__viewport');

            if (!viewport) {
                console.warn(`‚ö†Ô∏è No se encontr√≥ viewport para el carrusel: ${productId}`);
                return;
            }

            console.log(`üîß Inicializando carrusel para: ${productId}`);

            // Configuraci√≥n principal del carrusel
            const options = {
                align: 'start',
                loop: true,
                skipSnaps: false,
                containScroll: 'keepSnaps',
                dragFree: false,
                speed: 10,
                startIndex: 0
            };

            // Plugins adicionales
            const plugins = [];

            // Autoplay si est√° habilitado
            if (container.dataset.autoplay === 'true' && typeof EmblaCarouselAutoplay !== 'undefined') {
                plugins.push(EmblaCarouselAutoplay({
                    delay: 4000,
                    stopOnInteraction: true,
                    playOnInit: true
                }));
                console.log(`‚ñ∂Ô∏è Autoplay habilitado para: ${productId}`);
            }

            // Inicializar carrusel principal
            const embla = EmblaCarousel(viewport, options, plugins);

            console.log(`‚úÖ Carrusel principal creado para: ${productId}`);

            // Configurar botones de navegaci√≥n
            const prevBtn = container.querySelector('.embla__button--prev');
            const nextBtn = container.querySelector('.embla__button--next');

            if (prevBtn) {
                prevBtn.addEventListener('click', embla.scrollPrev, false);
                prevBtn.setAttribute('aria-label', 'Anterior');
            }
            if (nextBtn) {
                nextBtn.addEventListener('click', embla.scrollNext, false);
                nextBtn.setAttribute('aria-label', 'Siguiente');
            }

            // Configurar miniaturas si existen
            let thumbsEmbla = null;
            if (thumbsViewport) {
                console.log(`üñºÔ∏è Configurando miniaturas optimizadas para: ${productId}`);

                thumbsEmbla = EmblaCarousel(thumbsViewport, {
                    containScroll: 'keepSnaps',
                    dragFree: true,
                    dragThreshold: 10, // Lower threshold for smoother scrolling
                    axis: 'x',
                    align: 'start',
                    skipSnaps: false,
                    inViewThreshold: 0.7,
                    watchDrag: true,
                    watchResize: true,
                    watchSlides: true
                });

                const syncScrollSnap = () => {
                    const selected = embla.selectedScrollSnap();

                    // Smooth scroll to selected thumbnail with better centering
                    thumbsEmbla.scrollTo(selected, true);

                    // Actualizar clases de selecci√≥n en miniaturas con mejor feedback visual
                    container.querySelectorAll('.embla-thumbs__slide').forEach(function(slide, index) {
                        if (index === selected) {
                            slide.classList.add('embla-thumbs__slide--selected');
                            slide.setAttribute('aria-current', 'true');

                            // A√±adir scroll suave para centrar la miniatura seleccionada
                            const thumbRect = slide.getBoundingClientRect();
                            const containerRect = thumbsViewport.getBoundingClientRect();
                            const thumbCenter = thumbRect.left + thumbRect.width / 2;
                            const containerCenter = containerRect.left + containerRect.width / 2;

                            if (Math.abs(thumbCenter - containerCenter) > thumbRect.width) {
                                thumbsEmbla.scrollTo(selected, true);
                            }
                        } else {
                            slide.classList.remove('embla-thumbs__slide--selected');
                            slide.removeAttribute('aria-current');
                        }
                    });
                };

                // Enhanced click handlers para miniaturas con mejor feedback
                container.querySelectorAll('.embla-thumbs__slide').forEach(function(thumb, index) {
                    // Click handler con animaci√≥n mejorada
                    thumb.addEventListener('click', function(e) {
                        console.log(`üñ±Ô∏è Miniatura clickeada: ${productId}, √≠ndice: ${index}`);

                        // A√±adir feedback visual inmediato
                        thumb.style.transform = 'scale(0.95)';

                        // Navegar al slide con animaci√≥n suave
                        embla.scrollTo(index, true);

                        // Restaurar escala despu√©s de un breve momento
                        setTimeout(() => {
                            thumb.style.transform = '';
                        }, 150);

                        // Prevenir comportamientos no deseados
                        e.preventDefault();
                    }, false);

                    // Enhanced keyboard support
                    thumb.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            embla.scrollTo(index, true);
                        } else if (e.key === 'ArrowLeft') {
                            e.preventDefault();
                            embla.scrollPrev();
                        } else if (e.key === 'ArrowRight') {
                            e.preventDefault();
                            embla.scrollNext();
                        }
                    });

                    // Touch feedback para dispositivos m√≥viles
                    thumb.addEventListener('touchstart', function(e) {
                        thumb.style.transform = 'scale(0.95)';
                    }, { passive: true });

                    thumb.addEventListener('touchend', function(e) {
                        setTimeout(() => {
                            thumb.style.transform = '';
                        }, 100);
                    }, { passive: true });

                    // Hover mejorado para desktop
                    thumb.addEventListener('mouseenter', function() {
                        if (window.innerWidth > 768) {
                            this.style.zIndex = '10';
                        }
                    });

                    thumb.addEventListener('mouseleave', function() {
                        this.style.zIndex = '';
                    });
                });

                // Sincronizaci√≥n bidireccional mejorada
                embla.on('select', syncScrollSnap);
                embla.on('init', syncScrollSnap);

                // Sincronizaci√≥n cuando el usuario navega en las miniaturas
                thumbsEmbla.on('select', () => {
                    const selectedThumbIndex = thumbsEmbla.selectedScrollSnap();
                    if (selectedThumbIndex !== embla.selectedScrollSnap()) {
                        embla.scrollTo(selectedThumbIndex, true);
                    }
                });

                // Precargar im√°genes de miniaturas cercanas para mejor rendimiento
                const preloadThumbnails = () => {
                    const currentIndex = embla.selectedScrollSnap();
                    const thumbNodes = container.querySelectorAll('.embla-thumbs__slide img');

                    // Precargar miniaturas anteriores y siguientes
                    for (let i = Math.max(0, currentIndex - 2); i <= Math.min(thumbNodes.length - 1, currentIndex + 2); i++) {
                        const img = thumbNodes[i];
                        if (img && !img.complete) {
                            img.loading = 'eager';
                        }
                    }
                };

                embla.on('select', preloadThumbnails);
                embla.on('init', preloadThumbnails);

                // Inicializaci√≥n
                syncScrollSnap();
                console.log(`‚úÖ Miniaturas optimizadas configuradas para: ${productId}`);
            }

            // Configurar estados de los botones
            const setupButtonStates = () => {
                const prevDisabled = !embla.canScrollPrev();
                const nextDisabled = !embla.canScrollNext();
                if (prevBtn) prevBtn.disabled = prevDisabled;
                if (nextBtn) nextBtn.disabled = nextDisabled;
            };

            embla.on('select', setupButtonStates);
            embla.on('init', setupButtonStates);

            // Soporte de teclado para el carrusel principal
            const handleKeyDown = (e) => {
                switch(e.key) {
                    case 'ArrowLeft':
                        e.preventDefault();
                        embla.scrollPrev();
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        embla.scrollNext();
                        break;
                    case 'Home':
                        e.preventDefault();
                        embla.scrollTo(0);
                        break;
                    case 'End':
                        e.preventDefault();
                        embla.scrollTo(embla.scrollSnapList().length - 1);
                        break;
                }
            };

            container.addEventListener('keydown', handleKeyDown);
            container.setAttribute('tabindex', '0');

            // Pausar autoplay en hover (si est√° habilitado)
            if (container.dataset.autoplay === 'true') {
                container.addEventListener('mouseenter', () => {
                    if (embla.plugins().autoplay) {
                        embla.plugins().autoplay.stop();
                    }
                });

                container.addEventListener('mouseleave', () => {
                    if (embla.plugins().autoplay) {
                        embla.plugins().autoplay.play();
                    }
                });
            }

            // Enhanced image preloading for 14-18 images scenario
            const preloadNearbyImages = () => {
                const currentIndex = embla.selectedScrollSnap();
                const totalSlides = embla.scrollSnapList().length;
                const slides = embla.slideNodes();

                // Precargar im√°genes estrat√©gicamente para carruseles con muchas im√°genes
                const preloadRange = totalSlides > 12 ? 3 : 2; // M√°s rango para carruseles grandes

                // Precargar im√°genes alrededor de la actual
                for (let i = Math.max(0, currentIndex - preloadRange); i <= Math.min(totalSlides - 1, currentIndex + preloadRange); i++) {
                    const slide = slides[i];
                    if (slide) {
                        const img = slide.querySelector('img');
                        if (img && !img.complete) {
                            img.loading = 'eager';

                            // Agregar lazy loading a im√°genes lejanas
                            if (Math.abs(i - currentIndex) > preloadRange) {
                                img.loading = 'lazy';
                            }
                        }
                    }
                }

                // Optimizar miniaturas cargadas
                const thumbImages = container.querySelectorAll('.embla-thumbs__slide img');
                thumbImages.forEach((img, index) => {
                    const distanceFromCurrent = Math.abs(index - currentIndex);

                    if (distanceFromCurrent <= 2) {
                        // Miniaturas cercanas: alta prioridad
                        img.loading = 'eager';
                        img.fetchPriority = 'high';
                    } else if (distanceFromCurrent <= 5) {
                        // Miniaturas medias: prioridad normal
                        img.loading = 'lazy';
                        img.fetchPriority = 'auto';
                    } else {
                        // Miniaturas lejanas: baja prioridad
                        img.loading = 'lazy';
                        img.fetchPriority = 'low';
                    }
                });
            };

            embla.on('select', preloadNearbyImages);
            embla.on('init', preloadNearbyImages);

            // Optimizaci√≥n para carruseles con muchas im√°genes (14-18)
            const optimizeForManyImages = () => {
                const totalSlides = embla.scrollSnapList().length;

                if (totalSlides > 12) {
                    console.log(`üîß Optimizando carrusel con ${totalSlides} im√°genes para: ${productId}`);

                    // Ajustar velocidad de autoplay si hay muchas im√°genes
                    if (container.dataset.autoplay === 'true' && embla.plugins().autoplay) {
                        embla.plugins().autoplay.stop();
                        embla.plugins().autoplay.play({
                            delay: Math.min(3000, 4000 - (totalSlides * 100)), // M√°s r√°pido con m√°s im√°genes
                            stopOnInteraction: true,
                            playOnInit: true
                        });
                    }

                    // Agregar indicadores de progreso si hay muchas im√°genes
                    if (totalSlides > 15) {
                        addScrollIndicators();
                    }
                }
            };

            // Add scroll indicators for very long carousels
            const addScrollIndicators = () => {
                const thumbsViewport = container.querySelector('.embla-thumbs__viewport');
                if (!thumbsViewport || thumbsViewport.querySelector('.scroll-indicators')) return;

                const indicators = document.createElement('div');
                indicators.className = 'scroll-indicators absolute top-0 right-2 bg-white bg-opacity-90 rounded-full px-2 py-1 text-xs text-gray-600 shadow-sm';
                indicators.style.zIndex = '20';

                const updateIndicators = () => {
                    const scrollLeft = thumbsViewport.scrollLeft;
                    const maxScroll = thumbsViewport.scrollWidth - thumbsViewport.clientWidth;
                    const progress = maxScroll > 0 ? (scrollLeft / maxScroll) * 100 : 0;

                    indicators.textContent = `${Math.round(progress)}%`;
                };

                thumbsViewport.addEventListener('scroll', updateIndicators);
                thumbsViewport.appendChild(indicators);

                updateIndicators();
            };

            optimizeForManyImages();

            // Manejo de errores en im√°genes
            const handleImageErrors = () => {
                container.querySelectorAll('.embla__slide__img').forEach(function(img) {
                    if (!img.complete || img.naturalHeight === 0) {
                        img.addEventListener('error', function() {
                            console.warn(`‚ö†Ô∏è Error cargando imagen: ${img.src}`);
                            img.style.display = 'none';

                            // Mostrar placeholder
                            const placeholder = document.createElement('div');
                            placeholder.className = 'embla__slide__placeholder';
                            placeholder.innerHTML = `
                                <div style="
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    height: 100%;
                                    background: #f0f0f0;
                                    color: #666;
                                    font-size: 14px;
                                    text-align: center;
                                    padding: 20px;
                                ">
                                    Imagen no disponible
                                </div>
                            `;
                            img.parentNode.appendChild(placeholder);
                        });
                    }
                });
            };

            handleImageErrors();

            // Detecci√≥n de gestos t√°ctiles avanzados
            let touchStartX = 0;
            let touchStartY = 0;
            let touchEndX = 0;
            let touchEndY = 0;
            let isDragging = false;

            const handleTouchStart = (e) => {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
                isDragging = false;
                container.classList.add('dragging');
            };

            const handleTouchMove = (e) => {
                if (!isDragging) {
                    const deltaX = Math.abs(e.touches[0].clientX - touchStartX);
                    const deltaY = Math.abs(e.touches[0].clientY - touchStartY);

                    // Considerar como arrastre si el movimiento horizontal es mayor que el vertical
                    if (deltaX > deltaY && deltaX > 10) {
                        isDragging = true;
                    }
                }
            };

            const handleTouchEnd = (e) => {
                container.classList.remove('dragging');

                if (!isDragging) return;

                touchEndX = e.changedTouches[0].clientX;
                touchEndY = e.changedTouches[0].clientY;

                const deltaX = touchEndX - touchStartX;
                const deltaY = touchEndY - touchStartY;

                // Umbral m√≠nimo para swipe horizontal
                const minSwipeDistance = 50;

                if (Math.abs(deltaX) > minSwipeDistance && Math.abs(deltaY) < minSwipeDistance) {
                    if (deltaX > 0) {
                        // Swipe derecha - anterior
                        embla.scrollPrev();
                        console.log(`üëÜ Swipe derecho en ${productId}`);
                    } else {
                        // Swipe izquierda - siguiente
                        embla.scrollNext();
                        console.log(`üëà Swipe izquierdo en ${productId}`);
                    }
                }
            };

            // Agregar event listeners t√°ctiles
            viewport.addEventListener('touchstart', handleTouchStart, { passive: true });
            viewport.addEventListener('touchmove', handleTouchMove, { passive: true });
            viewport.addEventListener('touchend', handleTouchEnd, { passive: true });

            // Mostrar hint de swipe para usuarios nuevos (solo en m√≥viles)
            if (window.innerWidth <= 768 && !localStorage.getItem('carouselSwipeHintShown')) {
                setTimeout(() => {
                    const hint = document.createElement('div');
                    hint.className = 'swipe-hint';
                    hint.textContent = 'Desliza para ver m√°s im√°genes';
                    container.appendChild(hint);

                    setTimeout(() => {
                        hint.remove();
                        localStorage.setItem('carouselSwipeHintShown', 'true');
                    }, 3000);
                }, 2000);
            }

            // Manejo de resize
            const handleResize = () => {
                if (embla) {
                    embla.reInit();
                }
            };

            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(handleResize, 250);
            });

            // Manejo de visibilidad de p√°gina
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    // Pausar autoplay si la p√°gina no est√° visible
                    if (embla.plugins().autoplay) {
                        embla.plugins().autoplay.stop();
                    }
                } else if (container.dataset.autoplay === 'true') {
                    // Reanudar autoplay si la p√°gina se hace visible
                    if (embla.plugins().autoplay) {
                        embla.plugins().autoplay.play();
                    }
                }
            });

            console.log(`üéâ Carrusel completamente configurado para: ${productId}`);
        });

        console.log('‚úÖ Todos los carruseles inicializados correctamente');

    } catch (error) {
        console.error('‚ùå Error al inicializar carruseles:', error);
    }
}

// Funci√≥n global para inicializaci√≥n (llamada desde Layout.astro)
window.initCarousels = initializeSwipers;
window.initializeSwipers = initializeSwipers;

// Funci√≥n para inicializar gu√≠as de talles
function initializeSizeGuides() {
    const sizeGuideContainers = document.querySelectorAll('.size-guide-container');
    
    sizeGuideContainers.forEach(container => {
        const toggle = container.querySelector('.size-guide-toggle');
        const content = container.querySelector('.size-guide-content');
        const icon = container.querySelector('.toggle-icon');
        
        if (toggle && content && icon) {
            toggle.addEventListener('click', function() {
                const isOpen = container.classList.contains('open');
                
                if (isOpen) {
                    container.classList.remove('open');
                    content.classList.add('hidden');
                    icon.textContent = '+';
                    icon.style.transform = 'rotate(0deg)';
                } else {
                    container.classList.add('open');
                    content.classList.remove('hidden');
                    icon.textContent = '-';
                    icon.style.transform = 'rotate(45deg)';
                }
            });
        }
    });
}

// Funci√≥n para inicializar testimonios
function initializeTestimonials() {
    const testimonialsGrid = document.getElementById('testimonials-grid');
    const loadMoreBtn = document.getElementById('load-more-testimonials');
    const loadingIndicator = document.getElementById('testimonials-loading');
    
    if (!testimonialsGrid) return;

    // Lista de testimonios disponibles
    const allTestimonials = [
        { src: 'comentarios/comentariorecibi1.webp', alt: 'Captura de comentario positivo de clienta 1' },
        { src: 'comentarios/comentariorecibi2.webp', alt: 'Captura de comentario positivo de clienta 2' },
        { src: 'comentarios/comentariorecibi4.webp', alt: 'Captura de comentario positivo de clienta 3' },
        { src: 'comentarios/comentariorecibi5.webp', alt: 'Captura de comentario positivo de clienta 4' },
        { src: 'comentarios/comentariorecibi6.webp', alt: 'Captura de comentario positivo de clienta 5' },
        { src: 'comentarios/comentariorecibi7.webp', alt: 'Captura de comentario positivo de clienta 6' },
        { src: 'comentarios/comentariorecibi8.webp', alt: 'Captura de comentario positivo de clienta 7' },
        { src: 'comentarios/comentariosig.webp', alt: 'Comentarios de Instagram' },
        { src: 'comentarios/comentario1-min.webp', alt: 'Testimonio destacado 1' },
        { src: 'comentarios/comentario2-min.webp', alt: 'Testimonio destacado 2' },
        { src: 'comentarios/comentario3-min.webp', alt: 'Referencia de clienta satisfecha 1' },
        { src: 'comentarios/comentario4-min.webp', alt: 'Referencia de clienta satisfecha 2' },
        { src: 'comentarios/comentario5-min.webp', alt: 'Referencia de clienta satisfecha 3' }
    ];

    let currentIndex = 0;
    const itemsPerLoad = 6;

    function loadTestimonials() {
        const endIndex = Math.min(currentIndex + itemsPerLoad, allTestimonials.length);
        
        for (let i = currentIndex; i < endIndex; i++) {
            const testimonial = allTestimonials[i];
            const testimonialElement = document.createElement('div');
            testimonialElement.className = 'testimonial-item bg-white rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-all duration-300';
            testimonialElement.innerHTML = `
                <img src="${testimonial.src}" alt="${testimonial.alt}"
                     class="w-full h-auto object-contain"
                     loading="lazy">
            `;
            testimonialsGrid.appendChild(testimonialElement);
        }
        
        currentIndex = endIndex;
        
        // Ocultar bot√≥n de cargar m√°s si no hay m√°s testimonios
        if (currentIndex >= allTestimonials.length && loadMoreBtn) {
            loadMoreBtn.style.display = 'none';
        }
    }

    // Cargar testimonios iniciales
    loadTestimonials();

    // Event listener para cargar m√°s testimonios
    if (loadMoreBtn) {
        loadMoreBtn.addEventListener('click', function() {
            if (loadingIndicator) {
                loadingIndicator.style.display = 'block';
                loadMoreBtn.style.display = 'none';
            }
            
            // Simular carga y mostrar m√°s despu√©s de un momento
            setTimeout(() => {
                loadTestimonials();
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
                if (currentIndex < allTestimonials.length) {
                    loadMoreBtn.style.display = 'inline-block';
                }
            }, 800);
        });
    }
}

// Inicializaci√≥n cuando el DOM est√° listo
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Inicializando aplicaci√≥n...');
    
    // Inicializar carrito
    initializeCart();
    
    // Inicializar gu√≠as de talles
    initializeSizeGuides();
    
    // Inicializar testimonios
    initializeTestimonials();
    
    // Inicializar Swiper con un peque√±o delay para asegurar que todo est√© cargado
    setTimeout(initializeSwipers, 200);
    
    console.log('‚úÖ Aplicaci√≥n inicializada correctamente');
});

// Tambi√©n inicializar cuando la ventana est√© completamente cargada
window.addEventListener('load', function() {
    console.log('üîÑ Re-inicializando Swiper despu√©s de load...');
    setTimeout(initializeSwipers, 100);
});

// Funci√≥n global para inicializaci√≥n manual (para debugging)
window.debugSwipers = function() {
    console.log('üêõ Debug Swipers');
    console.log('Swiper disponible:', typeof Swiper !== 'undefined');
    
    // Verificar si los elementos existen
    ['guillermina-negras', 'guillermina-camel', 'guillermina-blancas'].forEach(product => {
        const mainElement = document.getElementById(`swiper-${product}`);
        const thumbElement = document.getElementById(`swiper-thumbnails-${product}`);
        console.log(`Producto ${product}:`, {
            main: !!mainElement,
            thumb: !!thumbElement,
            mainId: `swiper-${product}`,
            thumbId: `swiper-thumbnails-${product}`
        });
    });
    
    // Intentar inicializar
    initializeSwipers();
};

// WhatsApp Modal Functions
function showWhatsAppModal() {
    const modal = document.getElementById('whatsapp-modal');
    if (!modal) {
        console.error('WhatsApp modal not found');
        return;
    }

    modal.classList.remove('hidden');
    modal.classList.add('flex');

    // Focus on input
    setTimeout(() => {
        const input = document.getElementById('whatsapp-number');
        if (input) {
            input.focus();
        }
    }, 300);

    // Prevent body scroll
    document.body.style.overflow = 'hidden';

    // Close modal on escape key
    const handleEscape = (e) => {
        if (e.key === 'Escape') {
            closeWhatsAppModal();
            document.removeEventListener('keydown', handleEscape);
        }
    };
    document.addEventListener('keydown', handleEscape);

    // Store handler reference for cleanup
    modal._escapeHandler = handleEscape;
}

function closeWhatsAppModal() {
    const modal = document.getElementById('whatsapp-modal');
    if (!modal) return;

    modal.classList.add('hidden');
    modal.classList.remove('flex');

    // Restore body scroll
    document.body.style.overflow = '';

    // Remove escape handler if exists
    if (modal._escapeHandler) {
        document.removeEventListener('keydown', modal._escapeHandler);
        modal._escapeHandler = null;
    }

    // Clear form
    const form = document.getElementById('whatsapp-form');
    if (form) {
        form.reset();
    }
}

// WhatsApp endpoints (originales)
const validateWhatsappEndpoint = "https://sswebhookss.odontolab.co/webhook/02eb0643-1b9d-4866-87a7-f892d6a945ea";
const saveWhatsappEndpoint = "https://sswebhookss.odontolab.co/webhook/1d018fb5-b798-4218-9c57-b48e3a71c6a7";

function formatWhatsappNumber(number) {
    if (!number) return '';

    let formatted = number.replace(/[\s\-()]/g, '');

    if (formatted.startsWith('54') && formatted.length === 12) {
        formatted = '+' + formatted;
    } else if (formatted.length === 10) {
        formatted = '+549' + formatted;
    } else if (formatted.length === 11 && formatted.startsWith('9')) {
        formatted = '+54' + formatted;
    } else if (formatted.length === 12 && !formatted.startsWith('+')) {
        formatted = '+' + formatted;
    }

    return formatted;
}

function validateInputFormat(inputValue) {
    if (!inputValue) return false;
    const formattedNumber = formatWhatsappNumber(inputValue);
    return formattedNumber && formattedNumber.length >= 12;
}

async function validateWhatsappNumber(whatsappNumber) {
    try {
        const response = await fetch(validateWhatsappEndpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ whatsapp_check: whatsappNumber })
        });

        const result = await response.json();
        return { valid: response.ok, result };
    } catch (error) {
        console.error('Error validating WhatsApp:', error);
        return { valid: false, error };
    }
}

function saveWhatsappToEndpoint(whatsappNumber) {
    const data = {
        whatsapp: whatsappNumber,
        timestamp: new Date().toISOString(),
        source: 'modal_whatsapp_carrito',
        url: window.location.href,
        cart: window.cart,
        cartCount: window.cartCount
    };

    const xhr = new XMLHttpRequest();
    xhr.open('POST', saveWhatsappEndpoint, true);
    xhr.setRequestHeader('Content-Type', 'application/json');
    xhr.send(JSON.stringify(data));
}

async function handleWhatsAppSubmit(event) {
    event.preventDefault();

    const phoneNumber = document.getElementById('whatsapp-number').value.trim();

    if (!phoneNumber) {
        alert('Por favor ingresa tu n√∫mero de WhatsApp');
        return;
    }

    if (!validateInputFormat(phoneNumber)) {
        alert('Formato de WhatsApp inv√°lido. Ej: 1156457057');
        return;
    }

    const whatsappNumber = formatWhatsappNumber(phoneNumber);

    // Validar n√∫mero con webhook
    const validation = await validateWhatsappNumber(whatsappNumber);
    if (!validation.valid) {
        alert('N√∫mero de WhatsApp inv√°lido. Por favor verif√≠calo e intenta nuevamente.');
        return;
    }

    // Guardar en localStorage
    const whatsappData = {
        phone: whatsappNumber,
        cart: window.cart,
        cartCount: window.cartCount,
        timestamp: new Date().toISOString()
    };

    localStorage.setItem('whatsappCartSave', JSON.stringify(whatsappData));

    // Guardar en endpoint original
    saveWhatsappToEndpoint(whatsappNumber);

    // Generar enlace de recuperaci√≥n
    const recoveryLink = `${window.location.origin}${window.location.pathname}?whatsapp=${encodeURIComponent(phoneNumber)}`;

    // Construir mensaje de WhatsApp
    const message = encodeURIComponent(
        `¬°Hola! Soy Rosita Rococ√≥ üíï\n\n` +
        `Gracias por tu pedido en la tienda:\n` +
        `üõí ${window.cartCount} par(es) en tu carrito\n` +
        `üí∞ Total: $${calculateTotal().toLocaleString('es-AR')}\n\n` +
        `üîó Recupera tu carrito cuando quieras:\n${recoveryLink}\n\n` +
        `Para continuar con tu compra, haz clic en el enlace y completa tus datos. ¬°Te esperamos! üíï`
    );

    // Abrir WhatsApp con el mensaje
    const whatsappUrl = `https://wa.me/${whatsappNumber.replace('+', '')}?text=${message}`;
    window.open(whatsappUrl, '_blank');

    // Mostrar mensaje de √©xito
    showInlineMessage('‚úÖ ¬°Te enviamos un WhatsApp con el enlace para recuperar tu carrito!', 'success', 5000);

    // Cerrar modal
    closeWhatsAppModal();

    // Marcar modal como mostrado para esta sesi√≥n
    localStorage.setItem('whatsappModalShown', 'true');
}

// Initialize WhatsApp form when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    const whatsappForm = document.getElementById('whatsapp-form');
    if (whatsappForm) {
        whatsappForm.addEventListener('submit', handleWhatsAppSubmit);
    }

    // Check if cart can be recovered from WhatsApp
    const urlParams = new URLSearchParams(window.location.search);
    const whatsappParam = urlParams.get('whatsapp');

    if (whatsappParam) {
        try {
            const savedCartData = localStorage.getItem('whatsappCartSave');
            if (savedCartData) {
                const savedData = JSON.parse(savedCartData);
                if (savedData.phone === whatsappParam && savedData.cart.length > 0) {
                    // Restore cart
                    window.cart = savedData.cart;
                    window.cartCount = savedData.cartCount;
                    updateCartUI();

                    showInlineMessage('‚úÖ ¬°Carrito recuperado exitosamente!', 'success', 5000);

                    // Remove WhatsApp parameter from URL
                    const newUrl = window.location.pathname;
                    window.history.replaceState({}, '', newUrl);
                }
            }
        } catch (error) {
            console.error('Error recovering cart from WhatsApp:', error);
        }
    }
});

// Estilos CSS para mensajes del carrito (se agregan din√°micamente)
const cartStyles = `
    /* Mini Cart Responsive */
    #mini-cart {
        position: fixed;
        right: 1rem;
        top: 5rem;
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        padding: 1rem;
        width: 24rem;
        max-width: 90vw;
        z-index: 50;
        transform: translateX(100%);
        opacity: 0;
        pointer-events: none;
        transition: all 0.3s ease;
        max-height: 70vh;
        overflow-y: auto;
    }
    
    @media (max-width: 768px) {
        #mini-cart {
            position: fixed;
            right: 0;
            top: 0;
            left: 0;
            bottom: 0;
            width: 100%;
            max-width: 100vw;
            max-height: 100vh;
            border-radius: 0;
            transform: translateX(100%);
        }
    }
    
    .cart-message {
        position: relative;
        display: flex;
        align-items: center;
        padding: 12px 16px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        animation: slideInMessage 0.4s ease-out;
    }
    
    .cart-message:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .message-text {
        flex-grow: 1;
        font-weight: 500;
        line-height: 1.4;
    }
    
    .message-close {
        background: transparent;
        border: none;
        font-size: 18px;
        color: rgba(0, 0, 0, 0.4);
        cursor: pointer;
        padding: 4px;
        border-radius: 50%;
        transition: all 0.2s ease;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .message-close:hover {
        background: rgba(0, 0, 0, 0.1);
        color: rgba(0, 0, 0, 0.7);
        transform: scale(1.1);
    }
    
    @keyframes slideInMessage {
        from {
            opacity: 0;
            transform: translateX(-20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
    
    /* Testimonials Grid Styles - Natural Content */
    .testimonials-grid {
        display: grid;
        grid-template-columns: repeat(1, minmax(0, 1fr));
        gap: 2rem;
        width: 100%;
    }

    @media (min-width: 768px) {
        .testimonials-grid {
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 1.5rem;
        }
    }

    @media (min-width: 1024px) {
        .testimonials-grid {
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 2rem;
        }
    }

    .testimonial-item {
        opacity: 0;
        transform: translateY(30px);
        animation: fadeInUp 0.6s ease forwards;
        width: 100%;
        height: auto;
        /* No forzar aspect-ratio, dejar contenido natural */
    }

    /* Importante: No forzar tama√±os en las im√°genes */
    .testimonial-item img {
        width: 100%;
        height: auto;
        object-fit: contain;
        display: block;
        max-width: 100%;
    }

    .testimonial-item:nth-child(n) {
        animation-delay: calc(n * 0.1s);
    }
    
    @keyframes fadeInUp {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .cart-item {
        transition: all 0.3s ease;
    }
    
    .cart-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .remove-item {
        transition: all 0.2s ease;
    }
    
    .remove-item:hover {
        background: rgba(239, 68, 68, 0.1);
        transform: scale(1.1);
    }
`;

// Agregar estilos al head
const styleSheet = document.createElement('style');
styleSheet.textContent = cartStyles;
document.head.appendChild(styleSheet);
"
